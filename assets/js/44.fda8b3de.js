(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{459:function(i,s,l){"use strict";l.r(s);var t=l(18),e=Object(t.a)({},(function(){var i=this,s=i.$createElement,l=i._self._c||s;return l("ContentSlotsDistributor",{attrs:{"slot-key":i.$parent.slotKey}},[l("h2",{attrs:{id:"设计模式之观察者模式"}},[l("a",{staticClass:"header-anchor",attrs:{href:"#设计模式之观察者模式"}},[i._v("#")]),i._v(" 设计模式之观察者模式")]),i._v(" "),l("p",[i._v("观察者模式又叫发布订阅模式（Publish/Subscribe），它定义了一种一对多的关系，让多个观察者对象同时监听某一个主题对象，这个主题对象的状态发生变化时就会通知所有的观察者对象，使得它们能够自动更新自己。")]),i._v(" "),l("p",[i._v("使用观察者模式的好处：")]),i._v(" "),l("ol",[l("li",[i._v("支持简单的广播通信，自动通知所有已经订阅过的对象。")]),i._v(" "),l("li",[i._v("页面载入后目标对象很容易与观察者存在一种动态关联，增加了灵活性。")]),i._v(" "),l("li",[i._v("目标对象与观察者之间的抽象耦合关系能够单独扩展以及重用。")])]),i._v(" "),l("h2",{attrs:{id:"正文-版本一"}},[l("a",{staticClass:"header-anchor",attrs:{href:"#正文-版本一"}},[i._v("#")]),i._v(" "),l("strong",[i._v("正文（版本一）")])]),i._v(" "),l("p",[i._v("JS里对观察者模式的实现是通过回调来实现的，我们来先定义一个pubsub对象，其内部包含了3个方法：订阅、退订、发布。")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("var pubsub = {};(function (q) {\n    var topics = {}, // 回调函数存放的数组        subUid = -1;    // 发布方法    q.publish = function (topic, args) {\n        if (!topics[topic]) {            return false;        }\n        setTimeout(function () {            var subscribers = topics[topic],                len = subscribers ? subscribers.length : 0;\n            while (len--) {                subscribers[len].func(topic, args);            }        }, 0);\n        return true;\n    };    //订阅方法    q.subscribe = function (topic, func) {\n        if (!topics[topic]) {            topics[topic] = [];        }\n        var token = (++subUid).toString();        topics[topic].push({            token: token,            func: func        });        return token;    };    //退订方法    q.unsubscribe = function (token) {        for (var m in topics) {            if (topics[m]) {                for (var i = 0, j = topics[m].length; i < j; i++) {                    if (topics[m][i].token === token) {                        topics[m].splice(i, 1);                        return token;                    }                }            }        }        return false;    };} (pubsub));\n")])])]),l("p",[i._v("使用方式如下：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("//来，订阅一个pubsub.subscribe('example1', function (topics, data) {    console.log(topics + \": \" + data);});\n//发布通知pubsub.publish('example1', 'hello world!');pubsub.publish('example1', ['test', 'a', 'b', 'c']);pubsub.publish('example1', [{ 'color': 'blue' }, { 'text': 'hello'}]);\n")])])]),l("p",[i._v("怎么样？用起来是不是很爽？但是这种方式有个问题，就是没办法退订订阅，要退订的话必须指定退订的名称，所以我们再来一个版本：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("//将订阅赋值给一个变量，以便退订var testSubscription = pubsub.subscribe('example1', function (topics, data) {    console.log(topics + \": \" + data);});\n//发布通知pubsub.publish('example1', 'hello world!');pubsub.publish('example1', ['test', 'a', 'b', 'c']);pubsub.publish('example1', [{ 'color': 'blue' }, { 'text': 'hello'}]);\n//退订setTimeout(function () {    pubsub.unsubscribe(testSubscription);}, 0);\n//再发布一次，验证一下是否还能够输出信息pubsub.publish('example1', 'hello again! (this will fail)');\n")])])]),l("h2",{attrs:{id:"版本二"}},[l("a",{staticClass:"header-anchor",attrs:{href:"#版本二"}},[i._v("#")]),i._v(" "),l("strong",[i._v("版本二")])]),i._v(" "),l("p",[i._v("我们也可以利用原型的特性实现一个观察者模式，代码如下：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("function Observer() {    this.fns = [];}Observer.prototype = {    subscribe: function (fn) {        this.fns.push(fn);    },    unsubscribe: function (fn) {        this.fns = this.fns.filter(                        function (el) {                            if (el !== fn) {                                return el;                            }                        }                    );    },    update: function (o, thisObj) {        var scope = thisObj || window;        this.fns.forEach(                        function (el) {                            el.call(scope, o);                        }                    );    }};\n//测试var o = new Observer;var f1 = function (data) {    console.log('Robbin: ' + data + ', 赶紧干活了！');};\nvar f2 = function (data) {    console.log('Randall: ' + data + ', 找他加点工资去！');};\no.subscribe(f1);o.subscribe(f2);\no.update(\"Tom回来了！\")\n//退订f1o.unsubscribe(f1);//再来验证o.update(\"Tom回来了！\"); \n")])])]),l("p",[i._v("如果提示找不到filter或者forEach函数，可能是因为你的浏览器还不够新，暂时不支持新标准的函数，你可以使用如下方式自己定义：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("if (!Array.prototype.forEach) {    Array.prototype.forEach = function (fn, thisObj) {        var scope = thisObj || window;        for (var i = 0, j = this.length; i < j; ++i) {            fn.call(scope, this[i], i, this);        }    };}if (!Array.prototype.filter) {    Array.prototype.filter = function (fn, thisObj) {        var scope = thisObj || window;        var a = [];        for (var i = 0, j = this.length; i < j; ++i) {            if (!fn.call(scope, this[i], i, this)) {                continue;            }            a.push(this[i]);        }        return a;    };}\n")])])]),l("h2",{attrs:{id:"版本三"}},[l("a",{staticClass:"header-anchor",attrs:{href:"#版本三"}},[i._v("#")]),i._v(" "),l("strong",[i._v("版本三")])]),i._v(" "),l("p",[i._v("如果想让多个对象都具有观察者发布订阅的功能，我们可以定义一个通用的函数，然后将该函数的功能应用到需要观察者功能的对象上，代码如下：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("//通用代码var observer = {    //订阅    addSubscriber: function (callback) {        this.subscribers[this.subscribers.length] = callback;    },    //退订    removeSubscriber: function (callback) {        for (var i = 0; i this.subscribers.length; i++) {            if (this.subscribers[i] === callback) {                delete (this.subscribers[i]);            }        }    },    //发布    publish: function (what) {        for (var i = 0; i this.subscribers.length; i++) {            if (typeof this.subscribers[i] === 'function') {                this.subscribers[i](what);            }        }    },    // 将对象o具有观察者功能    make: function (o) {         for (var i in this) {            o[i] = this[i];            o.subscribers = [];        }    }};\n")])])]),l("p",[i._v("然后订阅2个对象blogger和user，使用observer.make方法将这2个对象具有观察者功能，代码如下：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("var blogger = {    recommend: function (id) {        var msg = 'dudu 推荐了的帖子:' + id;        this.publish(msg);    }};\nvar user = {    vote: function (id) {        var msg = '有人投票了!ID=' + id;        this.publish(msg);    }};\nobserver.make(blogger);observer.make(user);\n")])])]),l("p",[i._v("使用方法就比较简单了，订阅不同的回调函数，以便可以注册到不同的观察者对象里（也可以同时注册到多个观察者对象里）：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("var tom = {    read: function (what) {        console.log('Tom看到了如下信息：' + what)    }};\nvar mm = {    show: function (what) {        console.log('mm看到了如下信息：' + what)    }};// 订阅blogger.addSubscriber(tom.read);blogger.addSubscriber(mm.show);blogger.recommend(123); //调用发布\n//退订blogger.removeSubscriber(mm.show);blogger.recommend(456); //调用发布\n//另外一个对象的订阅user.addSubscriber(mm.show);user.vote(789); //调用发布\n")])])]),l("h2",{attrs:{id:"jquery版本"}},[l("a",{staticClass:"header-anchor",attrs:{href:"#jquery版本"}},[i._v("#")]),i._v(" "),l("strong",[i._v("jQuery版本")])]),i._v(" "),l("p",[i._v("根据jQuery1.7版新增的on/off功能，我们也可以定义jQuery版的观察者：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v("(function ($) {\n    var o = $({});\n    $.subscribe = function () {        o.on.apply(o, arguments);    };\n    $.unsubscribe = function () {        o.off.apply(o, arguments);    };\n    $.publish = function () {        o.trigger.apply(o, arguments);    };\n} (jQuery));\n")])])]),l("p",[i._v("调用方法比上面3个版本都简单：")]),i._v(" "),l("ul",[l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li"),i._v(" "),l("li")]),i._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[i._v('//回调函数function handle(e, a, b, c) {    // `e`是事件对象，不需要关注    console.log(a + b + c);};\n//订阅$.subscribe("/some/topic", handle);//发布$.publish("/some/topic", ["a", "b", "c"]); // 输出abc        \n$.unsubscribe("/some/topic", handle); // 退订\n//订阅$.subscribe("/some/topic", function (e, a, b, c) {    console.log(a + b + c);});\n$.publish("/some/topic", ["a", "b", "c"]); // 输出abc\n//退订（退订使用的是/some/topic名称，而不是回调函数哦，和版本一的例子不一样$.unsubscribe("/some/topic");\n')])])]),l("p",[i._v("可以看到，他的订阅和退订使用的是字符串名称，而不是回调函数名称，所以即便传入的是匿名函数，我们也是可以退订的。")]),i._v(" "),l("h2",{attrs:{id:"总结"}},[l("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[i._v("#")]),i._v(" "),l("strong",[i._v("总结")])]),i._v(" "),l("p",[i._v("观察者的使用场合就是：当一个对象的改变需要同时改变其它对象，并且它不知道具体有多少对象需要改变的时候，就应该考虑使用观察者模式。")]),i._v(" "),l("p",[i._v("总的来说，观察者模式所做的工作就是在解耦，让耦合的双方都依赖于抽象，而不是依赖于具体。从而使得各自的变化都不会影响到另一边的变化。")]),i._v(" "),l("p",[i._v("参考地址：")]),i._v(" "),l("p",[i._v("https://github.com/shichuan/javascript-patterns/blob/master/design-patterns/observer.html")]),i._v(" "),l("p",[i._v("http://www.addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript")]),i._v(" "),l("p",[i._v("https://gist.github.com/661855")]),i._v(" "),l("p",[i._v("本文完〜")]),i._v(" "),l("p",[l("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),i._v(" "),l("p",[l("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),i._v(" "),l("p",[i._v("喜欢此内容的人还喜欢")]),i._v(" "),l("p",[i._v('美团面试题：String s = new String("111")会创建几个对象？ 美团面试题：String s = new String("111")会创建几个对象？ ... 程序员乔戈里 不喜欢不看的原因确定内容质量低 不看此公众号Web开发应该学习的Token登录认证知识 Web开发应该学习的Token登录认证知识 ... Web开发 不喜欢不看的原因确定内容质量低 不看此公众号Git 使用教程｜最详细、最傻瓜、最浅显真正手把手教 Git 使用教程｜最详细、最傻瓜、最浅显真正手把手教 ... Nodejs技术栈 不喜欢不看的原因确定内容质量低 不看此公众号')]),i._v(" "),l("p",[l("img",{attrs:{src:"https://mp.weixin.qq.com/mp/qrcode?scene=10000004&size=102&__biz=MjM5MDA2MTI1MA==&mid=2649107686&idx=2&sn=e423b1bf53b78fb7b1f5787b40c247a7&send_time=",alt:"img"}})]),i._v(" "),l("p",[i._v("微信扫一扫\n关注该公众号")])])}),[],!1,null,null,null);s.default=e.exports}}]);