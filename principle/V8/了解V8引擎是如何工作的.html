<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>走进 Chrome 内心，了解 V8 引擎是如何工作的 | duangdong的note</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0088ce24040b03f2947322ab31d23414";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
    <script>
  var _hmt = _hmt || [];
  _hmt.push(['_requirePlugin', 'UrlChangeTracker', {
    shouldTrackUrlChange: function (newPath, oldPath) {
      newPath = newPath.split('#')[0];
      oldPath = oldPath.split('#')[0];
      return newPath != oldPath;
    }}
  ]);
  </script>
    <meta name="description" content="前端相关知识归纳总结">
    <meta name="keywords" content="qd-blog,node,vuepress,leetcode,algorithm">
    
    <link rel="preload" href="/assets/css/0.styles.a427ee9b.css" as="style"><link rel="preload" href="/assets/js/app.6df8e219.js" as="script"><link rel="preload" href="/assets/js/2.e21ead49.js" as="script"><link rel="preload" href="/assets/js/111.26f89c7d.js" as="script"><link rel="prefetch" href="/assets/js/10.e0bdad61.js"><link rel="prefetch" href="/assets/js/100.82a4c820.js"><link rel="prefetch" href="/assets/js/101.f5d94e3b.js"><link rel="prefetch" href="/assets/js/102.7f36fa51.js"><link rel="prefetch" href="/assets/js/103.085df24a.js"><link rel="prefetch" href="/assets/js/104.76789169.js"><link rel="prefetch" href="/assets/js/105.9efb3db9.js"><link rel="prefetch" href="/assets/js/106.22337f5b.js"><link rel="prefetch" href="/assets/js/107.ac8e17b4.js"><link rel="prefetch" href="/assets/js/108.5fe47bcc.js"><link rel="prefetch" href="/assets/js/109.cf88a409.js"><link rel="prefetch" href="/assets/js/11.e801cea9.js"><link rel="prefetch" href="/assets/js/110.603c3bd4.js"><link rel="prefetch" href="/assets/js/112.1ad5bc54.js"><link rel="prefetch" href="/assets/js/113.cde31a40.js"><link rel="prefetch" href="/assets/js/114.a1a2a895.js"><link rel="prefetch" href="/assets/js/115.31c25d8b.js"><link rel="prefetch" href="/assets/js/116.8ed4b493.js"><link rel="prefetch" href="/assets/js/117.c802c1ce.js"><link rel="prefetch" href="/assets/js/118.15aead28.js"><link rel="prefetch" href="/assets/js/119.c26b6aad.js"><link rel="prefetch" href="/assets/js/12.9ed8f981.js"><link rel="prefetch" href="/assets/js/120.c3410f53.js"><link rel="prefetch" href="/assets/js/121.357fc3f4.js"><link rel="prefetch" href="/assets/js/122.6ecee0a8.js"><link rel="prefetch" href="/assets/js/123.6b38e86a.js"><link rel="prefetch" href="/assets/js/124.463231bb.js"><link rel="prefetch" href="/assets/js/125.dc9f9675.js"><link rel="prefetch" href="/assets/js/126.97f340de.js"><link rel="prefetch" href="/assets/js/127.080209f1.js"><link rel="prefetch" href="/assets/js/128.dd7fed27.js"><link rel="prefetch" href="/assets/js/129.e9a49c7b.js"><link rel="prefetch" href="/assets/js/13.fb60e043.js"><link rel="prefetch" href="/assets/js/130.86b31ea7.js"><link rel="prefetch" href="/assets/js/131.be4dca8f.js"><link rel="prefetch" href="/assets/js/132.a4e032bd.js"><link rel="prefetch" href="/assets/js/133.545d53fa.js"><link rel="prefetch" href="/assets/js/134.ef4512f0.js"><link rel="prefetch" href="/assets/js/135.b15ec030.js"><link rel="prefetch" href="/assets/js/136.14e63782.js"><link rel="prefetch" href="/assets/js/137.671e87f8.js"><link rel="prefetch" href="/assets/js/138.b3d28a52.js"><link rel="prefetch" href="/assets/js/139.bc5e381c.js"><link rel="prefetch" href="/assets/js/14.63057fe7.js"><link rel="prefetch" href="/assets/js/140.ce3a69fc.js"><link rel="prefetch" href="/assets/js/141.09737b5b.js"><link rel="prefetch" href="/assets/js/142.49e3bb24.js"><link rel="prefetch" href="/assets/js/143.45031fa6.js"><link rel="prefetch" href="/assets/js/144.458e287e.js"><link rel="prefetch" href="/assets/js/145.9d21ff24.js"><link rel="prefetch" href="/assets/js/146.88d47473.js"><link rel="prefetch" href="/assets/js/147.277b5759.js"><link rel="prefetch" href="/assets/js/148.0dd5c138.js"><link rel="prefetch" href="/assets/js/149.d638ab21.js"><link rel="prefetch" href="/assets/js/15.3ac2cfb4.js"><link rel="prefetch" href="/assets/js/150.834eb5ca.js"><link rel="prefetch" href="/assets/js/151.0b833f48.js"><link rel="prefetch" href="/assets/js/152.d212207c.js"><link rel="prefetch" href="/assets/js/153.e8b1311a.js"><link rel="prefetch" href="/assets/js/154.74eb8531.js"><link rel="prefetch" href="/assets/js/16.f2129a31.js"><link rel="prefetch" href="/assets/js/17.27a38c73.js"><link rel="prefetch" href="/assets/js/18.ec5b4213.js"><link rel="prefetch" href="/assets/js/19.553ed8c2.js"><link rel="prefetch" href="/assets/js/20.c1bf3bbb.js"><link rel="prefetch" href="/assets/js/21.5790bc21.js"><link rel="prefetch" href="/assets/js/22.29894e1b.js"><link rel="prefetch" href="/assets/js/23.bae1a497.js"><link rel="prefetch" href="/assets/js/24.1edc62bc.js"><link rel="prefetch" href="/assets/js/25.69b254ca.js"><link rel="prefetch" href="/assets/js/26.df57f236.js"><link rel="prefetch" href="/assets/js/27.9ae48125.js"><link rel="prefetch" href="/assets/js/28.d42d4bb6.js"><link rel="prefetch" href="/assets/js/29.f3630e2f.js"><link rel="prefetch" href="/assets/js/3.5c47a171.js"><link rel="prefetch" href="/assets/js/30.40cf5507.js"><link rel="prefetch" href="/assets/js/31.99b2787c.js"><link rel="prefetch" href="/assets/js/32.eef578d9.js"><link rel="prefetch" href="/assets/js/33.6755a6d2.js"><link rel="prefetch" href="/assets/js/34.add65d5c.js"><link rel="prefetch" href="/assets/js/35.3e4a0da9.js"><link rel="prefetch" href="/assets/js/36.9d4bd3f9.js"><link rel="prefetch" href="/assets/js/37.98506fd6.js"><link rel="prefetch" href="/assets/js/38.44bce283.js"><link rel="prefetch" href="/assets/js/39.62bf281f.js"><link rel="prefetch" href="/assets/js/4.8f6f0475.js"><link rel="prefetch" href="/assets/js/40.3a389edd.js"><link rel="prefetch" href="/assets/js/41.a309beb7.js"><link rel="prefetch" href="/assets/js/42.4e87216c.js"><link rel="prefetch" href="/assets/js/43.c6f6922b.js"><link rel="prefetch" href="/assets/js/44.fda8b3de.js"><link rel="prefetch" href="/assets/js/45.5a1c5b3b.js"><link rel="prefetch" href="/assets/js/46.289cbb81.js"><link rel="prefetch" href="/assets/js/47.81850ce8.js"><link rel="prefetch" href="/assets/js/48.e986629d.js"><link rel="prefetch" href="/assets/js/49.d04a41c3.js"><link rel="prefetch" href="/assets/js/5.8b87f02a.js"><link rel="prefetch" href="/assets/js/50.727fb121.js"><link rel="prefetch" href="/assets/js/51.a10ac8b0.js"><link rel="prefetch" href="/assets/js/52.4fffa0ef.js"><link rel="prefetch" href="/assets/js/53.03ab34e0.js"><link rel="prefetch" href="/assets/js/54.f05ee208.js"><link rel="prefetch" href="/assets/js/55.f90df177.js"><link rel="prefetch" href="/assets/js/56.86a4d03e.js"><link rel="prefetch" href="/assets/js/57.c8cee71c.js"><link rel="prefetch" href="/assets/js/58.0b503f53.js"><link rel="prefetch" href="/assets/js/59.c4daebc4.js"><link rel="prefetch" href="/assets/js/6.2f86309f.js"><link rel="prefetch" href="/assets/js/60.b9584ba1.js"><link rel="prefetch" href="/assets/js/61.fa6e5de3.js"><link rel="prefetch" href="/assets/js/62.4f67908f.js"><link rel="prefetch" href="/assets/js/63.0c9d8ccc.js"><link rel="prefetch" href="/assets/js/64.2754e515.js"><link rel="prefetch" href="/assets/js/65.f2bd6dd5.js"><link rel="prefetch" href="/assets/js/66.299c952c.js"><link rel="prefetch" href="/assets/js/67.2ccaf3ef.js"><link rel="prefetch" href="/assets/js/68.b6e197f0.js"><link rel="prefetch" href="/assets/js/69.b821ea5d.js"><link rel="prefetch" href="/assets/js/7.f1cc41de.js"><link rel="prefetch" href="/assets/js/70.7beae76c.js"><link rel="prefetch" href="/assets/js/71.d452a791.js"><link rel="prefetch" href="/assets/js/72.f3fd5168.js"><link rel="prefetch" href="/assets/js/73.0804c5f0.js"><link rel="prefetch" href="/assets/js/74.cdcdfbcc.js"><link rel="prefetch" href="/assets/js/75.e8e01c97.js"><link rel="prefetch" href="/assets/js/76.6801837d.js"><link rel="prefetch" href="/assets/js/77.04408d97.js"><link rel="prefetch" href="/assets/js/78.9130c8b3.js"><link rel="prefetch" href="/assets/js/79.dcf60589.js"><link rel="prefetch" href="/assets/js/8.89fa1943.js"><link rel="prefetch" href="/assets/js/80.efe0c1a1.js"><link rel="prefetch" href="/assets/js/81.8220fef3.js"><link rel="prefetch" href="/assets/js/82.ae2099d2.js"><link rel="prefetch" href="/assets/js/83.c563f161.js"><link rel="prefetch" href="/assets/js/84.e365194b.js"><link rel="prefetch" href="/assets/js/85.15de0cdb.js"><link rel="prefetch" href="/assets/js/86.b99959c5.js"><link rel="prefetch" href="/assets/js/87.6fccf3fc.js"><link rel="prefetch" href="/assets/js/88.9bc0613a.js"><link rel="prefetch" href="/assets/js/89.89530022.js"><link rel="prefetch" href="/assets/js/9.7637f327.js"><link rel="prefetch" href="/assets/js/90.53d12303.js"><link rel="prefetch" href="/assets/js/91.c55896d7.js"><link rel="prefetch" href="/assets/js/92.0fe1f724.js"><link rel="prefetch" href="/assets/js/93.d681c01d.js"><link rel="prefetch" href="/assets/js/94.ed89d267.js"><link rel="prefetch" href="/assets/js/95.96e675de.js"><link rel="prefetch" href="/assets/js/96.5ad7361e.js"><link rel="prefetch" href="/assets/js/97.e7f32727.js"><link rel="prefetch" href="/assets/js/98.c3a03e67.js"><link rel="prefetch" href="/assets/js/99.31f54446.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a427ee9b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duangdong的note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link router-link-active">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link router-link-active">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/principle/" aria-current="page" class="sidebar-link">浏览器运行</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>V8</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/principle/V8/V8引擎垃圾回收与内存分配.html" class="sidebar-link">V8 引擎垃圾回收与内存分配</a></li><li><a href="/principle/V8/V8执行js的过程.html" class="sidebar-link">v8执行js的过程</a></li><li><a href="/principle/V8/了解V8引擎是如何工作的.html" class="active sidebar-link">走进 Chrome 内心，了解 V8 引擎是如何工作的</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>事件循环</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>堆栈</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>执行机制</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="走进-chrome-内心-了解-v8-引擎是如何工作的"><a href="#走进-chrome-内心-了解-v8-引擎是如何工作的" class="header-anchor">#</a> 走进 Chrome 内心，了解 V8 引擎是如何工作的</h2> <blockquote><p><a href="https://mp.weixin.qq.com/s/33pGm2qipnIyZ2V35AN8Ag" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/33pGm2qipnIyZ2V35AN8Ag<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="v8是什么"><a href="#v8是什么" class="header-anchor">#</a> V8是什么</h3> <p>在深入了解一件事物之前，首先要知道它是什么。</p> <p><code>V8</code>是一个由<code>Google</code>开源的采用<code>C++</code>编写的高性能<code>JavaScript</code>和<code>WebAssembly</code>引擎，应用在 <code>Chrome</code>和<code>Node.js</code>等中。它实现了<code>ECMAScript</code>和<code>WebAssembly</code>，运行在<code>Windows 7</code>及以上、<code>macOS 10.12+</code>以及使用<code>x64、IA-32、ARM</code>或<code>MIPS</code>处理器的<code>Linux</code>系统上。<code>V8</code>可以独立运行，也可以嵌入到任何<code>C++</code>应用程序中。</p> <h3 id="v8由来"><a href="#v8由来" class="header-anchor">#</a> V8由来</h3> <p>接下来我们来关心关心它如何诞生的，以及为什么叫这个名字。</p> <p>V8最初是由<code>Lars Bak</code>团队开发的，以汽车的<code>V8</code>发动机（有八个气缸的V型发动机）进行命名，预示着这将是一款性能极高的<code>JavaScript</code>引擎，在<code>2008年9月2号</code>同<code>chrome</code>一同开源发布。</p> <h3 id="为什么需要v8"><a href="#为什么需要v8" class="header-anchor">#</a> 为什么需要V8</h3> <p>我们写的<code>JavaScript</code>代码最终是要在机器中被执行的，但机器无法直接识别这些高级语言。需要经过一系列的处理，将高级语言转换成机器可以识别的的指令，也就是二进制码，交给机器执行。这中间的转换过程就是<code>V8</code>的具体工作。</p> <p>接下来我们就来详细的了解一下。</p> <h3 id="v8组成"><a href="#v8组成" class="header-anchor">#</a> V8组成</h3> <p>首先来看一下<code>V8</code>的内部组成。<code>V8</code>的内部有很多模块，其中最重要的4个如下：</p> <ul><li><strong>Parser</strong>: 解析器，负责将源代码解析成<code>AST</code></li> <li><strong>Ignition</strong>: 解释器，负责将<code>AST</code>转换成字节码并执行，同时会标记热点代码</li> <li><strong>TurboFan</strong>: 编译器，负责将热点代码编译成机器码并执行</li> <li><strong>Orinoco</strong>: 垃圾回收器，负责进行内存空间回收</li></ul> <h3 id="v8工作流程"><a href="#v8工作流程" class="header-anchor">#</a> V8工作流程</h3> <p>以下是<code>V8</code>中几个重要模块的具体工作流程图。我们逐个分析。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQS4V4wS8G66oIxp4ibnqPSaV5LJAQlaaTFOAdxoAfk8qadmHB7lucZP8ZRVSOGx8oOMNSyEfA0nx3w/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">V8工作流程.png</p> <h4 id="parser解析器"><a href="#parser解析器" class="header-anchor">#</a> Parser解析器</h4> <p>Parser解析器负责将源代码转换成抽象语法树<code>AST</code>。在转换过程中有两个重要的阶段：<code>词法分析（Lexical Analysis）</code>和<code>语法分析（Syntax Analysis）</code>。</p> <h5 id="词法分析"><a href="#词法分析" class="header-anchor">#</a> 词法分析</h5> <p>也称为分词，是将字符串形式的代码转换为标记（token）序列的过程。这里的<code>token</code>是一个字符串，是构成源代码的最小单位，类似于英语中单词。词法分析也可以理解成将英文字母组合成单词的过程。词法分析过程中不会关心单词之间的关系。比如：词法分析过程中能够将括号标记成<code>token</code>，但并不会校验括号是否匹配。</p> <p><code>JavaScript</code>中的<code>token</code>主要包含以下几种：</p> <blockquote><p>关键字：var、let、const等</p> <p>标识符：没有被引号括起来的连续字符，可能是一个变量，也可能是 if、else 这些关键字，又或者是 true、false 这些内置常量</p> <p>运算符：+、-、 *、/ 等</p> <p>数字：像十六进制，十进制，八进制以及科学表达式等</p> <p>字符串：变量的值等</p> <p>空格：连续的空格，换行，缩进等</p> <p>注释：行注释或块注释都是一个不可拆分的最小语法单元</p> <p>标点：大括号、小括号、分号、冒号等</p></blockquote> <p>以下是<code>const a = 'hello world'</code>经过<code>esprima</code>词法分析后生成的<code>tokens</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>[
    {
        &quot;type&quot;: &quot;Keyword&quot;,
        &quot;value&quot;: &quot;const&quot;
    },
    {
        &quot;type&quot;: &quot;Identifier&quot;,
        &quot;value&quot;: &quot;a&quot;
    },
    {
        &quot;type&quot;: &quot;Punctuator&quot;,
        &quot;value&quot;: &quot;=&quot;
    },
    {
        &quot;type&quot;: &quot;String&quot;,
        &quot;value&quot;: &quot;'hello world'&quot;
    }
]
</code></pre></div><h5 id="语法分析"><a href="#语法分析" class="header-anchor">#</a> 语法分析</h5> <p>语法分心是将词法分析产生的<code>token</code>按照某种给定的形式文法转换成<code>AST</code>的过程。也就是把单词组合成句子的过程。在转换过程中会验证语法，语法如果有错的话，会抛出语法错误。</p> <p>上述<code>const a = 'hello world'</code>经过语法分析后生成的<code>AST</code>如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;type&quot;: &quot;Program&quot;,
  &quot;body&quot;: [
    {
      &quot;type&quot;: &quot;VariableDeclaration&quot;,
      &quot;declarations&quot;: [
        {
          &quot;type&quot;: &quot;VariableDeclarator&quot;,
          &quot;id&quot;: {
            &quot;type&quot;: &quot;Identifier&quot;,
            &quot;name&quot;: &quot;a&quot;
          },
          &quot;init&quot;: {
            &quot;type&quot;: &quot;Literal&quot;,
            &quot;value&quot;: &quot;hello world&quot;,
            &quot;raw&quot;: &quot;'hello world'&quot;
          }
        }
      ],
      &quot;kind&quot;: &quot;const&quot;
    }
  ],
  &quot;sourceType&quot;: &quot;script&quot;
}
</code></pre></div><p>经过<code>Parser</code>解析器生成的<code>AST</code>将交由<code>Ignition</code>解释器进行处理。</p> <h4 id="ignition解释器"><a href="#ignition解释器" class="header-anchor">#</a> Ignition解释器</h4> <p>Ignition解释器负责将<code>AST</code>转换成字节码（Bytecode）并执行。字节码是介于<code>AST</code>和机器码之间的一种代码，与特定类型的机器代码无关，需要通过解释器转换成机器码才可以执行。</p> <p>看到这里想必大家都有疑惑，既然字节码也需要转换成机器码才能运行，那一开始为什么不直接将<code>AST</code>转换成机器码直接运行呢？转换成机器码直接运行速度肯定更快，那为什么还要加一个中间过程呢？</p> <p>其实在<code>V8</code>的<code>5.9</code>版本之前是没有字节码的，而是直接将JS代码编译成机器码并将机器码存储到内存中，这样就占用了大量的内存，而早期的手机内存都不高，过度的占用会导致手机性能大大的下降；而且直接编译成机器码导致编译时间长，启动速度慢；再者直接将JS代码转换成机器码需要针对不同的<code>CPU</code>架构编写不同的指令集，复杂度很高。</p> <p><code>5.9</code>版本以后引入了字节码，可以解决上述内存占用大、启动时间长、代码复杂度高这几个问题。</p> <p>接下来我们来看看<code>Ignition</code>是如何将<code>AST</code>转换成字节码的。</p> <p>下图是<code>Ignition</code>解释器的工作流程图。<code>AST</code>需要先通过字节码生成器，再经过一系列的优化之后才能生成字节码。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQS4V4wS8G66oIxp4ibnqPSaVOUCuRD9QC0ZanoKjeibl4h92ZLVeKELjBZQHvTYtgIuxf6ntU4c8dYQ/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">ignation.png</p> <p>其中的优化包括：</p> <ul><li><strong>Register Optimizer</strong>：主要是避免寄存器不必要的加载和存储</li> <li><strong>Peephole Optimizer</strong>：寻找字节码中可以复用的部分，并进行合并</li> <li><strong>Dead-code Elimination</strong>：删除无用的代码，减少字节码的大小</li></ul> <p>将代码转换成字节码后就可以通过解释器执行了。<code>Ignition</code>在执行的过程中，会监视代码的执行情况并记录执行信息，如函数的执行次数、每次执行函数时所传的参数等。</p> <p>当同一段代码被执行多次，就会被标记成热点代码。热点代码会交给<code>TurboFan</code>编译器进行处理。</p> <h3 id="turbofan编译器"><a href="#turbofan编译器" class="header-anchor">#</a> TurboFan编译器</h3> <p><code>TurboFan</code>拿到<code>Ignition</code>标记的热点代码后，会先进行优化处理，然后将优化后字节码编译成更高效的机器码存储起来。下次再次执行相同代码时，会直接执行相应的机器码，这样就在很大程度上提升了代码的执行效率。</p> <p>当一段代码不再是热点代码后，<code>TurboFan</code>会进行去优化的过程，将优化编译后的机器码还原成字节码，将代码的执行权利交还给<code>Ignition</code>。</p> <p>现在我们来看一看具体的执行过程。</p> <p>以<code>sum += arr[i]</code>为例，由于<code>JS</code>是动态类型的语言，每次的<code>sum</code>和<code>arr[i]</code>都有可能是不同的类型，在执行这段代码时，<code>Ignition</code>每次都会检查<code>sum</code>和<code>arr[i]</code>的数据类型。当发现同样的代码被执行了多次时，就将其标记为热点代码，交给<code>TurboFan</code>。</p> <p><code>TurboFan</code>在执行时，如果每次都判断<code>sum</code>和<code>arr[i]</code>的数据类型是很浪费时间的。因此在优化时，会根据之前的几次执行确定<code>sum</code>和<code>arr[i]</code>的数据类型，将其编译成机器码。下次再执行时，省去了判断数据类型的过程。</p> <p>但如果在后续的执行过程中，<code>arr[i]</code>的数据类型发生了改变，之前生成的机器码就不满足要求了，<code>TurboFan</code>会把之前生成的机器码丢弃，将执行权利再交给<code>Ignition</code>，完成去优化的过程。</p> <p>热点代码：
<img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQS4V4wS8G66oIxp4ibnqPSaVyvEyDb2NotXPnibaNJGiaV9EnvkpUaMhiaW1ibKFbSMiap9hiabKLOQGd7Og/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>优化前：
<img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQS4V4wS8G66oIxp4ibnqPSaVz21oBtLGutYSibJu24JSx1sUticJTj7jOiacIY4UIfmXyfqpFqCsBJTzg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <p>优化后：
<img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQS4V4wS8G66oIxp4ibnqPSaVWuISHLemaQtfBjSLTRia9bIvp8gYIZMRtH9UTOiaiarn5SNC85SZf3mJw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>现在我们来总结一下<code>V8</code>的执行过程：</p> <ol><li>源代码经过<code>Parser</code>解析器，经过词法分析和语法分析生成<code>AST</code></li> <li><code>AST</code>经过<code>Ignition</code>解释器生成字节码并执行</li> <li>在执行过程中，如果发现热点代码，将热点代码交给<code>TurboFan</code>编译器生成机器码并执行</li> <li>如果热点代码不再满足要求，进行去优化处理</li></ol> <p>这种字节码与解释器和编译器结合的技术，就是我们通常所说的即时编译(<code>JIT</code>)。</p> <p>本文并没有介绍垃圾回收器<code>Orinoco</code>，<code>V8</code>的垃圾回收机制可以单独用一篇文章来详细介绍，我们下期再见。</p> <p>关于本文</p> <h5 id="来源-阳呀呀"><a href="#来源-阳呀呀" class="header-anchor">#</a> 来源：阳呀呀</h5> <p>https://segmentfault.com/a/1190000040331440</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/27/2022, 9:04:59 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/principle/V8/V8执行js的过程.html" class="prev">
        v8执行js的过程
      </a></span> <span class="next"><a href="/principle/事件循环/EventLoop案例.html">
        EventLoop你知道它们的打印顺序吗？
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.6df8e219.js" defer></script><script src="/assets/js/2.e21ead49.js" defer></script><script src="/assets/js/111.26f89c7d.js" defer></script>
  </body>
</html>
