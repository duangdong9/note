<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DOM 变动观察器（Mutation observer） | duangdong的note</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0088ce24040b03f2947322ab31d23414";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
    <script>
  var _hmt = _hmt || [];
  _hmt.push(['_requirePlugin', 'UrlChangeTracker', {
    shouldTrackUrlChange: function (newPath, oldPath) {
      newPath = newPath.split('#')[0];
      oldPath = oldPath.split('#')[0];
      return newPath != oldPath;
    }}
  ]);
  </script>
    <meta name="description" content="前端相关知识归纳总结">
    <meta name="keywords" content="qd-blog,node,vuepress,leetcode,algorithm">
    
    <link rel="preload" href="/assets/css/0.styles.a427ee9b.css" as="style"><link rel="preload" href="/assets/js/app.6df8e219.js" as="script"><link rel="preload" href="/assets/js/2.e21ead49.js" as="script"><link rel="preload" href="/assets/js/20.c1bf3bbb.js" as="script"><link rel="prefetch" href="/assets/js/10.e0bdad61.js"><link rel="prefetch" href="/assets/js/100.82a4c820.js"><link rel="prefetch" href="/assets/js/101.f5d94e3b.js"><link rel="prefetch" href="/assets/js/102.7f36fa51.js"><link rel="prefetch" href="/assets/js/103.085df24a.js"><link rel="prefetch" href="/assets/js/104.76789169.js"><link rel="prefetch" href="/assets/js/105.9efb3db9.js"><link rel="prefetch" href="/assets/js/106.22337f5b.js"><link rel="prefetch" href="/assets/js/107.ac8e17b4.js"><link rel="prefetch" href="/assets/js/108.5fe47bcc.js"><link rel="prefetch" href="/assets/js/109.cf88a409.js"><link rel="prefetch" href="/assets/js/11.e801cea9.js"><link rel="prefetch" href="/assets/js/110.603c3bd4.js"><link rel="prefetch" href="/assets/js/111.26f89c7d.js"><link rel="prefetch" href="/assets/js/112.1ad5bc54.js"><link rel="prefetch" href="/assets/js/113.cde31a40.js"><link rel="prefetch" href="/assets/js/114.a1a2a895.js"><link rel="prefetch" href="/assets/js/115.31c25d8b.js"><link rel="prefetch" href="/assets/js/116.8ed4b493.js"><link rel="prefetch" href="/assets/js/117.c802c1ce.js"><link rel="prefetch" href="/assets/js/118.15aead28.js"><link rel="prefetch" href="/assets/js/119.c26b6aad.js"><link rel="prefetch" href="/assets/js/12.9ed8f981.js"><link rel="prefetch" href="/assets/js/120.c3410f53.js"><link rel="prefetch" href="/assets/js/121.357fc3f4.js"><link rel="prefetch" href="/assets/js/122.6ecee0a8.js"><link rel="prefetch" href="/assets/js/123.6b38e86a.js"><link rel="prefetch" href="/assets/js/124.463231bb.js"><link rel="prefetch" href="/assets/js/125.dc9f9675.js"><link rel="prefetch" href="/assets/js/126.97f340de.js"><link rel="prefetch" href="/assets/js/127.080209f1.js"><link rel="prefetch" href="/assets/js/128.dd7fed27.js"><link rel="prefetch" href="/assets/js/129.e9a49c7b.js"><link rel="prefetch" href="/assets/js/13.fb60e043.js"><link rel="prefetch" href="/assets/js/130.86b31ea7.js"><link rel="prefetch" href="/assets/js/131.be4dca8f.js"><link rel="prefetch" href="/assets/js/132.a4e032bd.js"><link rel="prefetch" href="/assets/js/133.545d53fa.js"><link rel="prefetch" href="/assets/js/134.ef4512f0.js"><link rel="prefetch" href="/assets/js/135.b15ec030.js"><link rel="prefetch" href="/assets/js/136.14e63782.js"><link rel="prefetch" href="/assets/js/137.671e87f8.js"><link rel="prefetch" href="/assets/js/138.b3d28a52.js"><link rel="prefetch" href="/assets/js/139.bc5e381c.js"><link rel="prefetch" href="/assets/js/14.63057fe7.js"><link rel="prefetch" href="/assets/js/140.ce3a69fc.js"><link rel="prefetch" href="/assets/js/141.09737b5b.js"><link rel="prefetch" href="/assets/js/142.49e3bb24.js"><link rel="prefetch" href="/assets/js/143.45031fa6.js"><link rel="prefetch" href="/assets/js/144.458e287e.js"><link rel="prefetch" href="/assets/js/145.9d21ff24.js"><link rel="prefetch" href="/assets/js/146.88d47473.js"><link rel="prefetch" href="/assets/js/147.277b5759.js"><link rel="prefetch" href="/assets/js/148.0dd5c138.js"><link rel="prefetch" href="/assets/js/149.d638ab21.js"><link rel="prefetch" href="/assets/js/15.3ac2cfb4.js"><link rel="prefetch" href="/assets/js/150.834eb5ca.js"><link rel="prefetch" href="/assets/js/151.0b833f48.js"><link rel="prefetch" href="/assets/js/152.d212207c.js"><link rel="prefetch" href="/assets/js/153.e8b1311a.js"><link rel="prefetch" href="/assets/js/154.74eb8531.js"><link rel="prefetch" href="/assets/js/16.f2129a31.js"><link rel="prefetch" href="/assets/js/17.27a38c73.js"><link rel="prefetch" href="/assets/js/18.ec5b4213.js"><link rel="prefetch" href="/assets/js/19.553ed8c2.js"><link rel="prefetch" href="/assets/js/21.5790bc21.js"><link rel="prefetch" href="/assets/js/22.29894e1b.js"><link rel="prefetch" href="/assets/js/23.bae1a497.js"><link rel="prefetch" href="/assets/js/24.1edc62bc.js"><link rel="prefetch" href="/assets/js/25.69b254ca.js"><link rel="prefetch" href="/assets/js/26.df57f236.js"><link rel="prefetch" href="/assets/js/27.9ae48125.js"><link rel="prefetch" href="/assets/js/28.d42d4bb6.js"><link rel="prefetch" href="/assets/js/29.f3630e2f.js"><link rel="prefetch" href="/assets/js/3.5c47a171.js"><link rel="prefetch" href="/assets/js/30.40cf5507.js"><link rel="prefetch" href="/assets/js/31.99b2787c.js"><link rel="prefetch" href="/assets/js/32.eef578d9.js"><link rel="prefetch" href="/assets/js/33.6755a6d2.js"><link rel="prefetch" href="/assets/js/34.add65d5c.js"><link rel="prefetch" href="/assets/js/35.3e4a0da9.js"><link rel="prefetch" href="/assets/js/36.9d4bd3f9.js"><link rel="prefetch" href="/assets/js/37.98506fd6.js"><link rel="prefetch" href="/assets/js/38.44bce283.js"><link rel="prefetch" href="/assets/js/39.62bf281f.js"><link rel="prefetch" href="/assets/js/4.8f6f0475.js"><link rel="prefetch" href="/assets/js/40.3a389edd.js"><link rel="prefetch" href="/assets/js/41.a309beb7.js"><link rel="prefetch" href="/assets/js/42.4e87216c.js"><link rel="prefetch" href="/assets/js/43.c6f6922b.js"><link rel="prefetch" href="/assets/js/44.fda8b3de.js"><link rel="prefetch" href="/assets/js/45.5a1c5b3b.js"><link rel="prefetch" href="/assets/js/46.289cbb81.js"><link rel="prefetch" href="/assets/js/47.81850ce8.js"><link rel="prefetch" href="/assets/js/48.e986629d.js"><link rel="prefetch" href="/assets/js/49.d04a41c3.js"><link rel="prefetch" href="/assets/js/5.8b87f02a.js"><link rel="prefetch" href="/assets/js/50.727fb121.js"><link rel="prefetch" href="/assets/js/51.a10ac8b0.js"><link rel="prefetch" href="/assets/js/52.4fffa0ef.js"><link rel="prefetch" href="/assets/js/53.03ab34e0.js"><link rel="prefetch" href="/assets/js/54.f05ee208.js"><link rel="prefetch" href="/assets/js/55.f90df177.js"><link rel="prefetch" href="/assets/js/56.86a4d03e.js"><link rel="prefetch" href="/assets/js/57.c8cee71c.js"><link rel="prefetch" href="/assets/js/58.0b503f53.js"><link rel="prefetch" href="/assets/js/59.c4daebc4.js"><link rel="prefetch" href="/assets/js/6.2f86309f.js"><link rel="prefetch" href="/assets/js/60.b9584ba1.js"><link rel="prefetch" href="/assets/js/61.fa6e5de3.js"><link rel="prefetch" href="/assets/js/62.4f67908f.js"><link rel="prefetch" href="/assets/js/63.0c9d8ccc.js"><link rel="prefetch" href="/assets/js/64.2754e515.js"><link rel="prefetch" href="/assets/js/65.f2bd6dd5.js"><link rel="prefetch" href="/assets/js/66.299c952c.js"><link rel="prefetch" href="/assets/js/67.2ccaf3ef.js"><link rel="prefetch" href="/assets/js/68.b6e197f0.js"><link rel="prefetch" href="/assets/js/69.b821ea5d.js"><link rel="prefetch" href="/assets/js/7.f1cc41de.js"><link rel="prefetch" href="/assets/js/70.7beae76c.js"><link rel="prefetch" href="/assets/js/71.d452a791.js"><link rel="prefetch" href="/assets/js/72.f3fd5168.js"><link rel="prefetch" href="/assets/js/73.0804c5f0.js"><link rel="prefetch" href="/assets/js/74.cdcdfbcc.js"><link rel="prefetch" href="/assets/js/75.e8e01c97.js"><link rel="prefetch" href="/assets/js/76.6801837d.js"><link rel="prefetch" href="/assets/js/77.04408d97.js"><link rel="prefetch" href="/assets/js/78.9130c8b3.js"><link rel="prefetch" href="/assets/js/79.dcf60589.js"><link rel="prefetch" href="/assets/js/8.89fa1943.js"><link rel="prefetch" href="/assets/js/80.efe0c1a1.js"><link rel="prefetch" href="/assets/js/81.8220fef3.js"><link rel="prefetch" href="/assets/js/82.ae2099d2.js"><link rel="prefetch" href="/assets/js/83.c563f161.js"><link rel="prefetch" href="/assets/js/84.e365194b.js"><link rel="prefetch" href="/assets/js/85.15de0cdb.js"><link rel="prefetch" href="/assets/js/86.b99959c5.js"><link rel="prefetch" href="/assets/js/87.6fccf3fc.js"><link rel="prefetch" href="/assets/js/88.9bc0613a.js"><link rel="prefetch" href="/assets/js/89.89530022.js"><link rel="prefetch" href="/assets/js/9.7637f327.js"><link rel="prefetch" href="/assets/js/90.53d12303.js"><link rel="prefetch" href="/assets/js/91.c55896d7.js"><link rel="prefetch" href="/assets/js/92.0fe1f724.js"><link rel="prefetch" href="/assets/js/93.d681c01d.js"><link rel="prefetch" href="/assets/js/94.ed89d267.js"><link rel="prefetch" href="/assets/js/95.96e675de.js"><link rel="prefetch" href="/assets/js/96.5ad7361e.js"><link rel="prefetch" href="/assets/js/97.e7f32727.js"><link rel="prefetch" href="/assets/js/98.c3a03e67.js"><link rel="prefetch" href="/assets/js/99.31f54446.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a427ee9b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duangdong的note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/advanced/" aria-current="page" class="sidebar-link">js 进阶</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>2-动画</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>3-高级api</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/advanced/3-高级api/JSB 原理与实践.html" class="sidebar-link">JSB 原理与实践</a></li><li><a href="/advanced/3-高级api/axios是如何封装HTTP请求的.html" class="sidebar-link">axios 是如何封装 HTTP 请求的</a></li><li><a href="/advanced/3-高级api/mutation-observer.html" class="active sidebar-link">DOM 变动观察器（Mutation observer）</a></li><li><a href="/advanced/3-高级api/《You-Dont-Know-JS》笔记小计.html" class="sidebar-link">《You-Dont-Know-JS》笔记小计</a></li><li><a href="/advanced/3-高级api/前端鉴权.html" class="sidebar-link">前端鉴权必须了解的5个兄弟：cookie、session、token、jwt、单点登录</a></li><li><a href="/advanced/3-高级api/发布订阅模式.html" class="sidebar-link">JavaScript的发布订阅模式</a></li><li><a href="/advanced/3-高级api/图解JavaScript继承.html" class="sidebar-link">图解 JavaScript 继承，一文搞定继承相关知识</a></li><li><a href="/advanced/3-高级api/基于js管理大文件上传以及断点续传.html" class="sidebar-link">基于js管理大文件上传以及断点续传</a></li><li><a href="/advanced/3-高级api/手写简易版的axios.html" class="sidebar-link">面试官不要再问我axios了？我能手写简易版的axios</a></li><li><a href="/advanced/3-高级api/页面生命周期.html" class="sidebar-link">页面生命周期：DOMContentLoaded，load，beforeunload，unload</a></li></ul></section></li><li><a href="/advanced/CORS完全手册之CORS详解.html" class="sidebar-link">CORS 完全手册之 CORS 详解</a></li><li><a href="/advanced/ES12新特性.html" class="sidebar-link">JavaScriptES12新特性抢先体验</a></li><li><a href="/advanced/前端模块化.html" class="sidebar-link">彻底掌握前端模块化</a></li><li><a href="/advanced/变量和类型-1.html" class="sidebar-link">变量和类型</a></li><li><a href="/advanced/变量和类型-2.html" class="sidebar-link">变量和类型-2</a></li><li><a href="/advanced/深入分析 JavaScript 模块循环引用.html" class="sidebar-link">深入分析 JavaScript 模块循环引用</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dom-变动观察器-mutation-observer"><a href="#dom-变动观察器-mutation-observer" class="header-anchor">#</a> DOM 变动观察器（Mutation observer）</h1> <blockquote><p><a href="https://mp.weixin.qq.com/s/oWI5M8VbLASPDXY34d6N5A" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/oWI5M8VbLASPDXY34d6N5A<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>MutationObserver</code> 是一个内建对象，它观察 DOM 元素，并在检测到更改时触发回调。</p></blockquote> <p>我们将首先看一下语法，然后探究一个实际的用例，以了解它在什么地方有用。</p> <h2 id="api语法"><a href="#api语法" class="header-anchor">#</a> api语法</h2> <blockquote><p><code>MutationObserver</code> 使用简单。</p></blockquote> <p>首先，我们创建一个带有回调函数的观察器：</p> <div class="language- extra-class"><pre class="language-text"><code>let observer = new MutationObserver(callback);
</code></pre></div><p>然后将其附加到一个 DOM 节点：</p> <div class="language- extra-class"><pre class="language-text"><code>observer.observe(node, config);
</code></pre></div><p><code>config</code> 是一个具有布尔选项的对象，该布尔选项表示“将对哪些更改做出反应”：</p> <ul><li><code>childList</code> —— <code>node</code> 的直接子节点的更改，</li> <li><code>subtree</code> —— <code>node</code> 的所有后代的更改，</li> <li><code>attributes</code> —— <code>node</code> 的特性（attribute），</li> <li><code>attributeFilter</code> —— 特性名称数组，只观察选定的特性。</li> <li><code>characterData</code> —— 是否观察 <code>node.data</code>（文本内容），</li></ul> <p>其他几个选项：</p> <ul><li><code>attributeOldValue</code> —— 如果为 <code>true</code>，则将特性的旧值和新值都传递给回调（参见下文），否则只传新值（需要 <code>attributes</code> 选项），</li> <li><code>characterDataOldValue</code> —— 如果为 <code>true</code>，则将 <code>node.data</code> 的旧值和新值都传递给回调（参见下文），否则只传新值（需要 <code>characterData</code> 选项）。</li></ul> <p>然后，在发生任何更改后，将执行“回调”：更改被作为一个 <strong>MutationRecord</strong>[1] 对象列表传入第一个参数，而观察器自身作为第二个参数。</p> <p><strong>MutationRecord</strong>[2] 对象具有以下属性：</p> <ul><li><p><code>type</code> —— 变动类型，以下类型之一：</p></li> <li><ul><li><code>&quot;attributes&quot;</code>：特性被修改了，</li> <li><code>&quot;characterData&quot;</code>：数据被修改了，用于文本节点，</li> <li><code>&quot;childList&quot;</code>：添加/删除了子元素。</li></ul></li> <li><p><code>target</code> —— 更改发生在何处：<code>&quot;attributes&quot;</code> 所在的元素，或 <code>&quot;characterData&quot;</code> 所在的文本节点，或 <code>&quot;childList&quot;</code> 变动所在的元素，</p></li> <li><p><code>addedNodes/removedNodes</code> —— 添加/删除的节点，</p></li> <li><p><code>previousSibling/nextSibling</code> —— 添加/删除的节点的上一个/下一个兄弟节点，</p></li> <li><p><code>attributeName/attributeNamespace</code> —— 被更改的特性的名称/命名空间（用于 XML），</p></li> <li><p><code>oldValue</code> —— 之前的值，仅适用于特性或文本更改，如果设置了相应选项 <code>attributeOldValue</code>/<code>characterDataOldValue</code>。</p></li></ul> <p>例如，这里有一个 <code>&lt;div&gt;</code>，它具有 <code>contentEditable</code> 特性。该特性使我们可以聚焦和编辑元素。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div contentEditable id<span class="token operator">=</span><span class="token string">&quot;elem&quot;</span><span class="token operator">&gt;</span>Click and <span class="token operator">&lt;</span>b<span class="token operator">&gt;</span>edit<span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token punctuation">,</span> please<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">let</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token parameter">mutationRecords</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mutationRecords<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// console.log(the changes)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 观察除了特性之外的所有变动</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">childList</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 观察直接子节点</span>
  <span class="token literal-property property">subtree</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 及其更低的后代节点</span>
  <span class="token literal-property property">characterDataOldValue</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 将旧的数据传递给回调</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>如果我们在浏览器中运行上面这段代码，并聚焦到给定的 <code>&lt;div&gt;</code> 上，然后更改 <code>&lt;b&gt;edit&lt;/b&gt;</code>中的文本，<code>console.log</code> 将显示一个变动：</p> <div class="language- extra-class"><pre class="language-text"><code>mutationRecords = [{
  type: &quot;characterData&quot;,
  oldValue: &quot;edit&quot;,
  target: &lt;text node&gt;,
  // 其他属性为空
}];
</code></pre></div><p>如果我们进行更复杂的编辑操作，例如删除 <code>&lt;b&gt;edit&lt;/b&gt;</code>，那么变动事件可能会包含多个变动记录：</p> <div class="language-js extra-class"><pre class="language-js"><code>mutationRecords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;childList&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token operator">&lt;</span>div#elem<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">removedNodes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>b<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">nextSibling</span><span class="token operator">:</span> <span class="token operator">&lt;</span>text node<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">previousSibling</span><span class="token operator">:</span> <span class="token operator">&lt;</span>text node<span class="token operator">&gt;</span>
  <span class="token comment">// 其他属性为空</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;characterData&quot;</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token operator">&lt;</span>text node<span class="token operator">&gt;</span>
  <span class="token comment">// ...变动的详细信息取决于浏览器如何处理此类删除</span>
  <span class="token comment">// 它可能是将两个相邻的文本节点 &quot;edit &quot; 和 &quot;, please&quot; 合并成一个节点，</span>
  <span class="token comment">// 或者可能将它们留在单独的文本节点中</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>因此，<code>MutationObserver</code> 允许对 DOM 子树中的任何更改作出反应。</p> <h2 id="用于集成"><a href="#用于集成" class="header-anchor">#</a> 用于集成</h2> <p>在什么时候可能有用？</p> <p>想象一下，你需要添加一个第三方脚本，该脚本不仅包含有用的功能，还会执行一些我们不想要的操作，例如显示广告 <code>&lt;div class=&quot;ads&quot;&gt;Unwanted ads&lt;/div&gt;</code>。</p> <p>当然，第三方脚本没有提供删除它的机制。</p> <p>使用 <code>MutationObserver</code>，我们可以监测到我们不需要的元素何时出现在我们的 DOM 中，并将其删除。</p> <p>还有一些其他情况，例如第三方脚本会将某些内容添加到我们的文档中，并且我们希望检测出这种情况何时发生，以调整页面，动态调整某些内容的大小等。</p> <p><code>MutationObserver</code> 使我们能够实现这种需求。</p> <h2 id="用于架构"><a href="#用于架构" class="header-anchor">#</a> 用于架构</h2> <p>从架构的角度来看，在某些情况下，<code>MutationObserver</code> 有不错的作用。</p> <p>假设我们正在建立一个有关编程的网站。自然地，文章和其他材料中可能包含源代码段。</p> <p>在 HTML 标记（markup）中的此类片段如下所示：</p> <div class="language- extra-class"><pre class="language-text"><code>...
&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code&gt;
  // 这里是代码
  let hello = &quot;world&quot;;
&lt;/code&gt;&lt;/pre&gt;
...
</code></pre></div><p>为了提高可读性，同时对其进行美化，我们将在我们的网站上使用 JavaScript 语法高亮显示库，例如 <strong>Prism.js</strong>[3]。为了使用 Prism 对以上代码片段进行语法高亮显示，我们调用了 <code>Prism.highlightElem(pre)</code>，它会检查此类 <code>pre</code> 元素的内容，并为这些元素添加特殊的标签（tag）和样式，以进行彩色语法高亮显示，类似于你在本文的示例中看到的那样。</p> <p>那么，我们应该在什么时候执行该高亮显示方法呢？我们可以在 <code>DOMContentLoaded</code> 事件中执行，或者将脚本放在页面的底部。DOM 就绪后，我们可以搜索元素 <code>pre[class*=&quot;language&quot;]</code> 并对其调用 <code>Prism.highlightElem</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>// 高亮显示页面上的所有代码段
document.querySelectorAll('pre[class*=&quot;language&quot;]').forEach(Prism.highlightElem);
</code></pre></div><p>到目前为止，一切都很简单，对吧？我们找到 HTML 中的代码片段并高亮显示它们。</p> <p>现在让我们继续。假设我们要从服务器动态获取资料。我们将 <strong>在本教程的后续章节</strong>[4] 中学习进行此操作的方法。目前，只需要关心我们从网络服务器获取 HTML 文章并按需显示：</p> <div class="language- extra-class"><pre class="language-text"><code>let article = /* 从服务器获取新内容 */
articleElem.innerHTML = article;
</code></pre></div><p>新的 <code>article</code> HTML 可能包含代码段。我们需要对其调用 <code>Prism.highlightElem</code>，否则它们将不会被高亮显示。</p> <p><strong>对于动态加载的文章，应该在何处何时调用 <code>Prism.highlightElem</code>？</strong></p> <p>我们可以将该调用附加到加载文章的代码中，如下所示：</p> <div class="language- extra-class"><pre class="language-text"><code>let article = /* 从服务器获取新内容 */
articleElem.innerHTML = article;

let snippets = articleElem.querySelectorAll('pre[class*=&quot;language-&quot;]');
snippets.forEach(Prism.highlightElem);
</code></pre></div><p>……但是，想象一下，如果代码中有很多地方都是在加载内容：文章，测验和论坛帖子等。我们是否需要在每个地方都附加一个高亮显示调用，以在内容加载完成后，高亮内容中的代码。那很不方便。</p> <p>并且，如果内容是由第三方模块加载的，该怎么办？例如，我们有一个由其他人编写的论坛，该论坛可以动态加载内容，并且我们想为其添加语法高亮显示。没有人喜欢修补第三方脚本。</p> <p>幸运的是，还有另一种选择。</p> <p>我们可以使用 <code>MutationObserver</code> 来自动检测何时在页面中插入了代码段，并高亮显示它们。</p> <p>因此，我们在一个地方处理高亮显示功能，从而使我们无需集成它。</p> <h3 id="动态高亮显示示例"><a href="#动态高亮显示示例" class="header-anchor">#</a> 动态高亮显示示例</h3> <p>这是一个工作示例。</p> <p>如果你运行这段代码，它将开始观察下面的元素，并高亮显示现在此处的所有代码段：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token parameter">mutations</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> mutation <span class="token keyword">of</span> mutations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查新节点，有什么需要高亮显示的吗？</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> node <span class="token keyword">of</span> mutation<span class="token punctuation">.</span>addedNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 我们只跟踪元素，跳过其他节点（例如文本节点）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">HTMLElement</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

      <span class="token comment">// 检查插入的元素是否为代码段</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">'pre[class*=&quot;language-&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Prism<span class="token punctuation">.</span><span class="token function">highlightElement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 或者可能在子树的某个地方有一个代码段？</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> elem <span class="token keyword">of</span> node<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'pre[class*=&quot;language-&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Prism<span class="token punctuation">.</span><span class="token function">highlightElement</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> demoElem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'highlight-demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>demoElem<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">childList</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">subtree</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下面有一个 HTML 元素，以及使用 <code>innerHTML</code> 动态填充它的 JavaScript。</p> <p>请先运行前面那段代码（上面那段，观察元素），然后运行下面这段代码。你将看到 <code>MutationObserver</code> 是如何检测并高亮显示代码段的。</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;p id=&quot;highlight-demo&quot; style=&quot;border: 1px solid #ddd&quot;&gt;一个具有 &lt;code&gt;id=&quot;highlight-demo&quot;&lt;/code&gt; 的示例元素，运行上面那段代码来观察它。&lt;/p&gt;
</code></pre></div><p>下面这段代码填充了其 <code>innerHTML</code>，这导致 <code>MutationObserver</code> 作出反应，并突出显示其内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> demoElem <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'highlight-demo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 动态插入带有代码段的内容</span>
demoElem<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">下面是一个代码段：
  &lt;pre class=&quot;language-javascript&quot;&gt;&lt;code&gt; let hello = &quot;world!&quot;; &lt;/code&gt;&lt;/pre&gt;
  &lt;div&gt;另一个代码段：&lt;/div&gt;
  &lt;div&gt;
    &lt;pre class=&quot;language-css&quot;&gt;&lt;code&gt;.class { margin: 5px; } &lt;/code&gt;&lt;/pre&gt;
  &lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>现在我们有了 <code>MutationObserver</code>，它可以跟踪观察到的元素中的，或者整个 <code>document</code> 中的所有高亮显示。我们可以在 HTML 中添加/删除代码段，而无需考虑高亮问题。</p> <h2 id="其他方法"><a href="#其他方法" class="header-anchor">#</a> 其他方法</h2> <p>有一个方法可以停止观察节点：</p> <ul><li><code>observer.disconnect()</code> —— 停止观察。</li></ul> <p>当我们停止观察时，观察器可能尚未处理某些更改。在种情况下，我们使用：</p> <ul><li><code>observer.takeRecords()</code> —— 获取尚未处理的变动记录列表，表中记录的是已经发生，但回调暂未处理的变动。</li></ul> <p>这些方法可以一起使用，如下所示：</p> <div class="language- extra-class"><pre class="language-text"><code>// 如果你关心可能未处理的近期的变动
// 那么，应该在 disconnect 前调用获取未处理的变动列表
let mutationRecords = observer.takeRecords();

// 停止跟踪变动
observer.disconnect();
...
</code></pre></div><blockquote><p><strong><code>observer.takeRecords()</code> 返回的记录被从处理队列中移除：</strong></p> <p>回调函数不会被 <code>observer.takeRecords()</code> 返回的记录调用。</p></blockquote> <blockquote><p><strong>垃圾回收：</strong></p> <p>观察器在内部对节点使用弱引用。也就是说，如果一个节点被从 DOM 中移除了，并且该节点变得不可访问，那么它就可以被垃圾回收。</p> <p>观察到 DOM 节点这一事实并不能阻止垃圾回收。</p></blockquote> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><code>MutationObserver</code> 可以对 DOM 的变化作出反应 —— 特性（attribute），文本内容，添加/删除元素。</p> <p>我们可以用它来跟踪代码其他部分引入的更改，以及与第三方脚本集成。</p> <p><code>MutationObserver</code> 可以跟踪任何更改。<code>config</code> “要观察的内容”选项用于优化，避免不必要的回调调用以节省资源。</p> <hr> <blockquote><p>现代 JavaScript 教程：开源的现代 JavaScript 从入门到进阶的优质教程。<strong>React 官方文档推荐，与 MDN 并列的 JavaScript 学习教程</strong>[5]。</p> <p>在线免费阅读：https://zh.javascript.info</p></blockquote> <hr> <h3 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h3> <p>[1]MutationRecord: <em>https://dom.spec.whatwg.org/#mutationrecord</em></p> <p>[2]MutationRecord: <em>https://dom.spec.whatwg.org/#mutationrecord</em></p> <p>[3]Prism.js: <em>https://prismjs.com/</em></p> <p>[4]在本教程的后续章节: <em>https://zh.javascript.info/fetch</em></p> <p>[5]React 官方文档推荐，与 MDN 并列的 JavaScript 学习教程: <em>https://zh-hans.reactjs.org/docs/getting-started.html#javascript-resources</em></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/27/2022, 9:04:59 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/3-高级api/axios是如何封装HTTP请求的.html" class="prev">
        axios 是如何封装 HTTP 请求的
      </a></span> <span class="next"><a href="/advanced/3-高级api/《You-Dont-Know-JS》笔记小计.html">
        《You-Dont-Know-JS》笔记小计
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.6df8e219.js" defer></script><script src="/assets/js/2.e21ead49.js" defer></script><script src="/assets/js/20.c1bf3bbb.js" defer></script>
  </body>
</html>
