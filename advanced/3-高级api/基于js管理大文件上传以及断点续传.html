<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于js管理大文件上传以及断点续传 | duangdong的note</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0088ce24040b03f2947322ab31d23414";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
    <script>
  var _hmt = _hmt || [];
  _hmt.push(['_requirePlugin', 'UrlChangeTracker', {
    shouldTrackUrlChange: function (newPath, oldPath) {
      newPath = newPath.split('#')[0];
      oldPath = oldPath.split('#')[0];
      return newPath != oldPath;
    }}
  ]);
  </script>
    <meta name="description" content="前端相关知识归纳总结">
    <meta name="keywords" content="qd-blog,node,vuepress,leetcode,algorithm">
    
    <link rel="preload" href="/assets/css/0.styles.a427ee9b.css" as="style"><link rel="preload" href="/assets/js/app.6df8e219.js" as="script"><link rel="preload" href="/assets/js/2.e21ead49.js" as="script"><link rel="preload" href="/assets/js/25.69b254ca.js" as="script"><link rel="prefetch" href="/assets/js/10.e0bdad61.js"><link rel="prefetch" href="/assets/js/100.82a4c820.js"><link rel="prefetch" href="/assets/js/101.f5d94e3b.js"><link rel="prefetch" href="/assets/js/102.7f36fa51.js"><link rel="prefetch" href="/assets/js/103.085df24a.js"><link rel="prefetch" href="/assets/js/104.76789169.js"><link rel="prefetch" href="/assets/js/105.9efb3db9.js"><link rel="prefetch" href="/assets/js/106.22337f5b.js"><link rel="prefetch" href="/assets/js/107.ac8e17b4.js"><link rel="prefetch" href="/assets/js/108.5fe47bcc.js"><link rel="prefetch" href="/assets/js/109.cf88a409.js"><link rel="prefetch" href="/assets/js/11.e801cea9.js"><link rel="prefetch" href="/assets/js/110.603c3bd4.js"><link rel="prefetch" href="/assets/js/111.26f89c7d.js"><link rel="prefetch" href="/assets/js/112.1ad5bc54.js"><link rel="prefetch" href="/assets/js/113.cde31a40.js"><link rel="prefetch" href="/assets/js/114.a1a2a895.js"><link rel="prefetch" href="/assets/js/115.31c25d8b.js"><link rel="prefetch" href="/assets/js/116.8ed4b493.js"><link rel="prefetch" href="/assets/js/117.c802c1ce.js"><link rel="prefetch" href="/assets/js/118.15aead28.js"><link rel="prefetch" href="/assets/js/119.c26b6aad.js"><link rel="prefetch" href="/assets/js/12.9ed8f981.js"><link rel="prefetch" href="/assets/js/120.c3410f53.js"><link rel="prefetch" href="/assets/js/121.357fc3f4.js"><link rel="prefetch" href="/assets/js/122.6ecee0a8.js"><link rel="prefetch" href="/assets/js/123.6b38e86a.js"><link rel="prefetch" href="/assets/js/124.463231bb.js"><link rel="prefetch" href="/assets/js/125.dc9f9675.js"><link rel="prefetch" href="/assets/js/126.97f340de.js"><link rel="prefetch" href="/assets/js/127.080209f1.js"><link rel="prefetch" href="/assets/js/128.dd7fed27.js"><link rel="prefetch" href="/assets/js/129.e9a49c7b.js"><link rel="prefetch" href="/assets/js/13.fb60e043.js"><link rel="prefetch" href="/assets/js/130.86b31ea7.js"><link rel="prefetch" href="/assets/js/131.be4dca8f.js"><link rel="prefetch" href="/assets/js/132.a4e032bd.js"><link rel="prefetch" href="/assets/js/133.545d53fa.js"><link rel="prefetch" href="/assets/js/134.ef4512f0.js"><link rel="prefetch" href="/assets/js/135.b15ec030.js"><link rel="prefetch" href="/assets/js/136.14e63782.js"><link rel="prefetch" href="/assets/js/137.671e87f8.js"><link rel="prefetch" href="/assets/js/138.b3d28a52.js"><link rel="prefetch" href="/assets/js/139.bc5e381c.js"><link rel="prefetch" href="/assets/js/14.63057fe7.js"><link rel="prefetch" href="/assets/js/140.ce3a69fc.js"><link rel="prefetch" href="/assets/js/141.09737b5b.js"><link rel="prefetch" href="/assets/js/142.49e3bb24.js"><link rel="prefetch" href="/assets/js/143.45031fa6.js"><link rel="prefetch" href="/assets/js/144.458e287e.js"><link rel="prefetch" href="/assets/js/145.9d21ff24.js"><link rel="prefetch" href="/assets/js/146.88d47473.js"><link rel="prefetch" href="/assets/js/147.277b5759.js"><link rel="prefetch" href="/assets/js/148.0dd5c138.js"><link rel="prefetch" href="/assets/js/149.d638ab21.js"><link rel="prefetch" href="/assets/js/15.3ac2cfb4.js"><link rel="prefetch" href="/assets/js/150.834eb5ca.js"><link rel="prefetch" href="/assets/js/151.0b833f48.js"><link rel="prefetch" href="/assets/js/152.d212207c.js"><link rel="prefetch" href="/assets/js/153.e8b1311a.js"><link rel="prefetch" href="/assets/js/154.74eb8531.js"><link rel="prefetch" href="/assets/js/16.f2129a31.js"><link rel="prefetch" href="/assets/js/17.27a38c73.js"><link rel="prefetch" href="/assets/js/18.ec5b4213.js"><link rel="prefetch" href="/assets/js/19.553ed8c2.js"><link rel="prefetch" href="/assets/js/20.c1bf3bbb.js"><link rel="prefetch" href="/assets/js/21.5790bc21.js"><link rel="prefetch" href="/assets/js/22.29894e1b.js"><link rel="prefetch" href="/assets/js/23.bae1a497.js"><link rel="prefetch" href="/assets/js/24.1edc62bc.js"><link rel="prefetch" href="/assets/js/26.df57f236.js"><link rel="prefetch" href="/assets/js/27.9ae48125.js"><link rel="prefetch" href="/assets/js/28.d42d4bb6.js"><link rel="prefetch" href="/assets/js/29.f3630e2f.js"><link rel="prefetch" href="/assets/js/3.5c47a171.js"><link rel="prefetch" href="/assets/js/30.40cf5507.js"><link rel="prefetch" href="/assets/js/31.99b2787c.js"><link rel="prefetch" href="/assets/js/32.eef578d9.js"><link rel="prefetch" href="/assets/js/33.6755a6d2.js"><link rel="prefetch" href="/assets/js/34.add65d5c.js"><link rel="prefetch" href="/assets/js/35.3e4a0da9.js"><link rel="prefetch" href="/assets/js/36.9d4bd3f9.js"><link rel="prefetch" href="/assets/js/37.98506fd6.js"><link rel="prefetch" href="/assets/js/38.44bce283.js"><link rel="prefetch" href="/assets/js/39.62bf281f.js"><link rel="prefetch" href="/assets/js/4.8f6f0475.js"><link rel="prefetch" href="/assets/js/40.3a389edd.js"><link rel="prefetch" href="/assets/js/41.a309beb7.js"><link rel="prefetch" href="/assets/js/42.4e87216c.js"><link rel="prefetch" href="/assets/js/43.c6f6922b.js"><link rel="prefetch" href="/assets/js/44.fda8b3de.js"><link rel="prefetch" href="/assets/js/45.5a1c5b3b.js"><link rel="prefetch" href="/assets/js/46.289cbb81.js"><link rel="prefetch" href="/assets/js/47.81850ce8.js"><link rel="prefetch" href="/assets/js/48.e986629d.js"><link rel="prefetch" href="/assets/js/49.d04a41c3.js"><link rel="prefetch" href="/assets/js/5.8b87f02a.js"><link rel="prefetch" href="/assets/js/50.727fb121.js"><link rel="prefetch" href="/assets/js/51.a10ac8b0.js"><link rel="prefetch" href="/assets/js/52.4fffa0ef.js"><link rel="prefetch" href="/assets/js/53.03ab34e0.js"><link rel="prefetch" href="/assets/js/54.f05ee208.js"><link rel="prefetch" href="/assets/js/55.f90df177.js"><link rel="prefetch" href="/assets/js/56.86a4d03e.js"><link rel="prefetch" href="/assets/js/57.c8cee71c.js"><link rel="prefetch" href="/assets/js/58.0b503f53.js"><link rel="prefetch" href="/assets/js/59.c4daebc4.js"><link rel="prefetch" href="/assets/js/6.2f86309f.js"><link rel="prefetch" href="/assets/js/60.b9584ba1.js"><link rel="prefetch" href="/assets/js/61.fa6e5de3.js"><link rel="prefetch" href="/assets/js/62.4f67908f.js"><link rel="prefetch" href="/assets/js/63.0c9d8ccc.js"><link rel="prefetch" href="/assets/js/64.2754e515.js"><link rel="prefetch" href="/assets/js/65.f2bd6dd5.js"><link rel="prefetch" href="/assets/js/66.299c952c.js"><link rel="prefetch" href="/assets/js/67.2ccaf3ef.js"><link rel="prefetch" href="/assets/js/68.b6e197f0.js"><link rel="prefetch" href="/assets/js/69.b821ea5d.js"><link rel="prefetch" href="/assets/js/7.f1cc41de.js"><link rel="prefetch" href="/assets/js/70.7beae76c.js"><link rel="prefetch" href="/assets/js/71.d452a791.js"><link rel="prefetch" href="/assets/js/72.f3fd5168.js"><link rel="prefetch" href="/assets/js/73.0804c5f0.js"><link rel="prefetch" href="/assets/js/74.cdcdfbcc.js"><link rel="prefetch" href="/assets/js/75.e8e01c97.js"><link rel="prefetch" href="/assets/js/76.6801837d.js"><link rel="prefetch" href="/assets/js/77.04408d97.js"><link rel="prefetch" href="/assets/js/78.9130c8b3.js"><link rel="prefetch" href="/assets/js/79.dcf60589.js"><link rel="prefetch" href="/assets/js/8.89fa1943.js"><link rel="prefetch" href="/assets/js/80.efe0c1a1.js"><link rel="prefetch" href="/assets/js/81.8220fef3.js"><link rel="prefetch" href="/assets/js/82.ae2099d2.js"><link rel="prefetch" href="/assets/js/83.c563f161.js"><link rel="prefetch" href="/assets/js/84.e365194b.js"><link rel="prefetch" href="/assets/js/85.15de0cdb.js"><link rel="prefetch" href="/assets/js/86.b99959c5.js"><link rel="prefetch" href="/assets/js/87.6fccf3fc.js"><link rel="prefetch" href="/assets/js/88.9bc0613a.js"><link rel="prefetch" href="/assets/js/89.89530022.js"><link rel="prefetch" href="/assets/js/9.7637f327.js"><link rel="prefetch" href="/assets/js/90.53d12303.js"><link rel="prefetch" href="/assets/js/91.c55896d7.js"><link rel="prefetch" href="/assets/js/92.0fe1f724.js"><link rel="prefetch" href="/assets/js/93.d681c01d.js"><link rel="prefetch" href="/assets/js/94.ed89d267.js"><link rel="prefetch" href="/assets/js/95.96e675de.js"><link rel="prefetch" href="/assets/js/96.5ad7361e.js"><link rel="prefetch" href="/assets/js/97.e7f32727.js"><link rel="prefetch" href="/assets/js/98.c3a03e67.js"><link rel="prefetch" href="/assets/js/99.31f54446.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a427ee9b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duangdong的note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/advanced/" aria-current="page" class="sidebar-link">js 进阶</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>2-动画</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>3-高级api</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/advanced/3-高级api/JSB 原理与实践.html" class="sidebar-link">JSB 原理与实践</a></li><li><a href="/advanced/3-高级api/axios是如何封装HTTP请求的.html" class="sidebar-link">axios 是如何封装 HTTP 请求的</a></li><li><a href="/advanced/3-高级api/mutation-observer.html" class="sidebar-link">DOM 变动观察器（Mutation observer）</a></li><li><a href="/advanced/3-高级api/《You-Dont-Know-JS》笔记小计.html" class="sidebar-link">《You-Dont-Know-JS》笔记小计</a></li><li><a href="/advanced/3-高级api/前端鉴权.html" class="sidebar-link">前端鉴权必须了解的5个兄弟：cookie、session、token、jwt、单点登录</a></li><li><a href="/advanced/3-高级api/发布订阅模式.html" class="sidebar-link">JavaScript的发布订阅模式</a></li><li><a href="/advanced/3-高级api/图解JavaScript继承.html" class="sidebar-link">图解 JavaScript 继承，一文搞定继承相关知识</a></li><li><a href="/advanced/3-高级api/基于js管理大文件上传以及断点续传.html" class="active sidebar-link">基于js管理大文件上传以及断点续传</a></li><li><a href="/advanced/3-高级api/手写简易版的axios.html" class="sidebar-link">面试官不要再问我axios了？我能手写简易版的axios</a></li><li><a href="/advanced/3-高级api/页面生命周期.html" class="sidebar-link">页面生命周期：DOMContentLoaded，load，beforeunload，unload</a></li></ul></section></li><li><a href="/advanced/CORS完全手册之CORS详解.html" class="sidebar-link">CORS 完全手册之 CORS 详解</a></li><li><a href="/advanced/ES12新特性.html" class="sidebar-link">JavaScriptES12新特性抢先体验</a></li><li><a href="/advanced/前端模块化.html" class="sidebar-link">彻底掌握前端模块化</a></li><li><a href="/advanced/变量和类型-1.html" class="sidebar-link">变量和类型</a></li><li><a href="/advanced/变量和类型-2.html" class="sidebar-link">变量和类型-2</a></li><li><a href="/advanced/深入分析 JavaScript 模块循环引用.html" class="sidebar-link">深入分析 JavaScript 模块循环引用</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="基于js管理大文件上传以及断点续传"><a href="#基于js管理大文件上传以及断点续传" class="header-anchor">#</a> 基于js管理大文件上传以及断点续传</h1> <blockquote><p><a href="https://mp.weixin.qq.com/s/jWGbhXEV0KtJu2pGfN4Hsg" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/jWGbhXEV0KtJu2pGfN4Hsg<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <blockquote><p>前端小伙伴们平常在开发过程中文件上传是经常遇到的一个问题，也许你能够实现相关的功能，但是做完后回想代码实现上是不是有点&quot;力不从心&quot;呢？你真的了解文件上传吗？如何做到大文件上传以及断电续传呢，前后端通讯常用的格式，文件上传进度管控，服务端是如何实现的？接下来让我们开启手摸手系列的学习吧！！！如有不足之处，望不吝指教，接下来按照下图进行学习探讨</p></blockquote> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQQz67vZFmU6qBFDwXicqIIKOk8gZNFfvnIqmpVxbVXsAn0W662McpNuhmE38v0F1pqBTeOxN1QGlrA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">一切就绪，开始吧！！！</p> <h2 id="前端结构"><a href="#前端结构" class="header-anchor">#</a> 前端结构</h2> <ul><li>页面展示</li></ul> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQQz67vZFmU6qBFDwXicqIIKOP0hS0iayf0ISRQia06vPDRVG0NNcsm7CfxaeSUQicDWPPQJMSPjaUibr1A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">image.png</p> <ul><li>项目依赖</li></ul> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQQz67vZFmU6qBFDwXicqIIKOuvDXcXKwY5Ln5VOKzziaFceKicTW2P57gmWMy9icnEHLlOpyOoIcy4olA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">依赖.png</p> <h2 id="后端结构-node-express"><a href="#后端结构-node-express" class="header-anchor">#</a> 后端结构(node + express)</h2> <ul><li><p>目录结构</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQQz67vZFmU6qBFDwXicqIIKOWIBicicW83Aicoavo1foT4pdhWnWUytN7kMUud228STQs4vShgUV2m8Gw/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">后台代码.png</p></li> <li><p>Axios的简单封装</p> <div class="language- extra-class"><pre class="language-text"><code>let instance = axios.create();
instance.defaults.baseURL = 'http://127.0.0.1:8888';
instance.defaults.headers['Content-Type'] = 'multipart/form-data';
instance.defaults.transformRequest = (data, headers) =&gt; {
  const contentType = headers['Content-Type'];
  if (contentType === &quot;application/x-www-form-urlencoded&quot;) return Qs.stringify(data);
  return data;
};
instance.interceptors.response.use(response =&gt; {
  return response.data;
});
复制代码
</code></pre></div></li></ul> <p><strong>文件上传一般是基于两种方式，<code>FormData</code>以及<code>Base64</code></strong></p> <h2 id="基于formdata实现文件上传"><a href="#基于formdata实现文件上传" class="header-anchor">#</a> 基于FormData实现文件上传</h2> <div class="language- extra-class"><pre class="language-text"><code> //前端代码
    // 主要展示基于ForData实现上传的核心代码
    upload_button_upload.addEventListener('click', function () {
            if (upload_button_upload.classList.contains('disable') || upload_button_upload.classList.contains('loading')) return;
            if (!_file) {
                alert('请您先选择要上传的文件~~');
                return;
            }
            changeDisable(true);
            // 把文件传递给服务器：FormData
            let formData = new FormData();
            // 根据后台需要提供的字段进行添加
            formData.append('file', _file);
            formData.append('filename', _file.name);
            instance.post('/upload_single', formData).then(data =&gt; {
                if (+data.code === 0) {
                    alert(`文件已经上传成功~~,您可以基于 ${data.servicePath} 访问这个资源~~`);
                    return;
                }
                return Promise.reject(data.codeText);
            }).catch(reason =&gt; {
                alert('文件上传失败，请您稍后再试~~');
            }).finally(() =&gt; {
                clearHandle();
                changeDisable(false);
            });
        });
复制代码
</code></pre></div><h2 id="基于base64实现文件上传"><a href="#基于base64实现文件上传" class="header-anchor">#</a> 基于BASE64实现文件上传</h2> <h3 id="base64具体方法"><a href="#base64具体方法" class="header-anchor">#</a> BASE64具体方法</h3> <ul><li><p>首先需要把文件流转为BASE64，这里可以封装一个方法</p> <div class="language- extra-class"><pre class="language-text"><code>export changeBASE64(file) =&gt; {
 return new Promise(resolve =&gt; {
  let fileReader = new FileReader();
  fileReader.readAsDataURL(file);
  fileReader.onload = ev =&gt; {
      resolve(ev.target.result);
  };
});
};
复制代码
</code></pre></div></li> <li><p>具体实现</p> <div class="language- extra-class"><pre class="language-text"><code>upload_inp.addEventListener('change', async function () {
      let file = upload_inp.files[0],
          BASE64,
          data;
      if (!file) return;
      if (file.size &gt; 2 * 1024 * 1024) {
          alert('上传的文件不能超过2MB~~');
          return;
      }
      upload_button_select.classList.add('loading');
      // 获取Base64
      BASE64 = await changeBASE64(file);
      try {
          data = await instance.post('/upload_single_base64', {
          // encodeURIComponent(BASE64) 防止传输过程中特殊字符乱码，同时后端需要用decodeURIComponent进行解码
              file: encodeURIComponent(BASE64),
              filename: file.name
          }, {
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded'
              }
          });
          if (+data.code === 0) {
              alert(`恭喜您，文件上传成功，您可以基于 ${data.servicePath} 地址去访问~~`);
              return;
          }
          throw data.codeText;
      } catch (err) {
          alert('很遗憾，文件上传失败，请您稍后再试~~');
      } finally {
          upload_button_select.classList.remove('loading');
      }
  **});**
复制代码
</code></pre></div></li></ul> <p><strong>上面这个例子中后端收到前端传过来的文件会对它进行生成一个随机的名字，存下来，但是有些公司会将这一步放在前端进行，生成名字后一起发给后端，接下来我们来实现这个功能</strong></p> <h3 id="前端生成文件名传给后端"><a href="#前端生成文件名传给后端" class="header-anchor">#</a> 前端生成文件名传给后端</h3> <p>这里就需要用到上面提到的插件<strong>SparkMD5</strong>[1],具体怎么用就不做赘述了，请参考文档</p> <ul><li><p>封装读取文件流的方法</p> <div class="language- extra-class"><pre class="language-text"><code>const changeBuffer = file =&gt; {
  return new Promise(resolve =&gt; {
      let fileReader = new FileReader();
      fileReader.readAsArrayBuffer(file);
      fileReader.onload = ev =&gt; {
          let buffer = ev.target.result,
              spark = new SparkMD5.ArrayBuffer(),
              HASH,
              suffix;
          spark.append(buffer);
          // 得到文件名
          HASH = spark.end();
          // 获取后缀名
          suffix = /\.([a-zA-Z0-9]+)$/.exec(file.name)[1];
          resolve({
              buffer,
              HASH,
              suffix,
              filename: `${HASH}.${suffix}`
          });
      };
  });
};
复制代码
</code></pre></div></li> <li><p>上传服务器相关代码</p> <div class="language- extra-class"><pre class="language-text"><code>upload_button_upload.addEventListener('click', async function () {
      if (checkIsDisable(this)) return;
      if (!_file) {
          alert('请您先选择要上传的文件~~');
          return;
      }
      changeDisable(true);
      // 生成文件的HASH名字
      let {
          filename
      } = await changeBuffer(_file);
      let formData = new FormData();
      formData.append('file', _file);
      formData.append('filename', filename);
      instance.post('/upload_single_name', formData).then(data =&gt; {
          if (+data.code === 0) {
              alert(`文件已经上传成功~~,您可以基于 ${data.servicePath} 访问这个资源~~`);
              return;
          }
          return Promise.reject(data.codeText);
      }).catch(reason =&gt; {
          alert('文件上传失败，请您稍后再试~~');
      }).finally(() =&gt; {
          changeDisable(false);
          upload_abbre.style.display = 'none';
          upload_abbre_img.src = '';
          _file = null;
      });
  });
复制代码
</code></pre></div></li></ul> <h2 id="上传进度管控"><a href="#上传进度管控" class="header-anchor">#</a> 上传进度管控</h2> <p>这个功能相对来说比较简单，文中用到的请求库是axios,进度管控主要基于axios提供的onUploadProgress函数进行实现，这里一起看下这个函数的实现原理</p> <ul><li><p>监听xhr.upload.onprogress</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片">监听.png</p></li> <li><p>文件上传后得到的对象</p> <p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片">xhr.png</p></li> <li><p>具体实现</p> <div class="language- extra-class"><pre class="language-text"><code>(function () {
  let upload = document.querySelector('#upload4'),
      upload_inp = upload.querySelector('.upload_inp'),
      upload_button_select = upload.querySelector('.upload_button.select'),
      upload_progress = upload.querySelector('.upload_progress'),
      upload_progress_value = upload_progress.querySelector('.value');

  // 验证是否处于可操作性状态
  const checkIsDisable = element =&gt; {
      let classList = element.classList;
      return classList.contains('disable') || classList.contains('loading');
  };

  upload_inp.addEventListener('change', async function () {
      let file = upload_inp.files[0],
          data;
      if (!file) return;
      upload_button_select.classList.add('loading');
      try {
          let formData = new FormData();
          formData.append('file', file);
          formData.append('filename', file.name);
          data = await instance.post('/upload_single', formData, {
              // 文件上传中的回调函数 xhr.upload.onprogress
              onUploadProgress(ev) {
                  let {
                      loaded,
                      total
                  } = ev;
                  upload_progress.style.display = 'block';
                  upload_progress_value.style.width = `${loaded/total*100}%`;
              }
          });
          if (+data.code === 0) {
              upload_progress_value.style.width = `100%`;
              alert(`恭喜您，文件上传成功，您可以基于 ${data.servicePath} 访问该文件~~`);
              return;
          }
          throw data.codeText;
      } catch (err) {
          alert('很遗憾，文件上传失败，请您稍后再试~~');
      } finally {
          upload_button_select.classList.remove('loading');
          upload_progress.style.display = 'none';
          upload_progress_value.style.width = `0%`;
      }
  });

  upload_button_select.addEventListener('click', function () {
      if (checkIsDisable(this)) return;
      upload_inp.click();
  });
})();
复制代码
</code></pre></div></li></ul> <h2 id="大文件上传"><a href="#大文件上传" class="header-anchor">#</a> 大文件上传</h2> <p>大文件上传一般采用切片上传的方式，这样可以提高文件上传的速度，前端拿到文件流后进行切片，然后与后端进行通讯传输，一般还会结合断点继传，这时后端一般提供三个接口，第一个接口获取已经上传的切片信息，第二个接口将前端切片文件进行传输，第三个接口是将所有切片上传完成后告诉后端进行文件合并<img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片"></p> <ul><li><p>进行切片，切片的方式分为固定数量以及固定大小，我们这里两者结合一下</p> <div class="language- extra-class"><pre class="language-text"><code>// 实现文件切片处理 「固定数量 &amp; 固定大小」
let max = 1024 * 100,
  count = Math.ceil(file.size / max),
  index = 0,
  chunks = [];
if (count &gt; 100) {
  max = file.size / 100;
  count = 100;
}
while (index &lt; count) {
  chunks.push({
  // file文件本身就具有slice方法，见下图
      file: file.slice(index * max, (index + 1) * max),
      filename: `${HASH}_${index+1}.${suffix}`
  });
  index++;
}
复制代码
</code></pre></div></li> <li><p>发送至服务端</p> <div class="language- extra-class"><pre class="language-text"><code>chunks.forEach(chunk =&gt; {
  let fm = new FormData;
  fm.append('file', chunk.file);
  fm.append('filename', chunk.filename);
  instance.post('/upload_chunk', fm).then(data =&gt; {
      if (+data.code === 0) {
          complate();
          return;
      }
      return Promise.reject(data.codeText);
  }).catch(() =&gt; {
      alert('当前切片上传失败，请您稍后再试~~');
      clear();
  });
 });
复制代码
</code></pre></div></li> <li><p>文件上传 + 断电续传 + 进度管控</p> <div class="language- extra-class"><pre class="language-text"><code>  upload_inp.addEventListener('change', async function () {
      let file = upload_inp.files[0];
      if (!file) return;
      upload_button_select.classList.add('loading');
      upload_progress.style.display = 'block';

      // 获取文件的HASH
      let already = [],
          data = null,
          {
              HASH,
              suffix
          } = await changeBuffer(file);

      // 获取已经上传的切片信息
      try {
          data = await instance.get('/upload_already', {
              params: {
                  HASH
              }
          });
          if (+data.code === 0) {
              already = data.fileList;
          }
      } catch (err) {}

      // 实现文件切片处理 「固定数量 &amp; 固定大小」
      let max = 1024 * 100,
          count = Math.ceil(file.size / max),
          index = 0,
          chunks = [];
      if (count &gt; 100) {
          max = file.size / 100;
          count = 100;
      }
      while (index &lt; count) {
          chunks.push({
              file: file.slice(index * max, (index + 1) * max),
              filename: `${HASH}_${index+1}.${suffix}`
          });
          index++;
      }

      // 上传成功的处理
      index = 0;
      const clear = () =&gt; {
          upload_button_select.classList.remove('loading');
          upload_progress.style.display = 'none';
          upload_progress_value.style.width = '0%';
      };
      const complate = async () =&gt; {
          // 管控进度条
          index++;
          upload_progress_value.style.width = `${index/count*100}%`;

          // 当所有切片都上传成功，我们合并切片
          if (index &lt; count) return;
          upload_progress_value.style.width = `100%`;
          try {
              data = await instance.post('/upload_merge', {
                  HASH,
                  count
              }, {
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded'
                  }
              });
              if (+data.code === 0) {
                  alert(`恭喜您，文件上传成功，您可以基于 ${data.servicePath} 访问该文件~~`);
                  clear();
                  return;
              }
              throw data.codeText;
          } catch (err) {
              alert('切片合并失败，请您稍后再试~~');
              clear();
          }
      };

      // 把每一个切片都上传到服务器上
      chunks.forEach(chunk =&gt; {
          // 已经上传的无需在上传
          if (already.length &gt; 0 &amp;&amp; already.includes(chunk.filename)) {
              complate();
              return;
          }
          let fm = new FormData;
          fm.append('file', chunk.file);
          fm.append('filename', chunk.filename);
          instance.post('/upload_chunk', fm).then(data =&gt; {
              if (+data.code === 0) {
                  complate();
                  return;
              }
              return Promise.reject(data.codeText);
          }).catch(() =&gt; {
              alert('当前切片上传失败，请您稍后再试~~');
              clear();
          });
      });
  });
复制代码
</code></pre></div></li></ul> <h2 id="服务端代码-大文件上传-断点续传"><a href="#服务端代码-大文件上传-断点续传" class="header-anchor">#</a> 服务端代码(大文件上传+断点续传)</h2> <div class="language- extra-class"><pre class="language-text"><code> // 大文件切片上传 &amp; 合并切片
    const merge = function merge(HASH, count) {
        return new Promise(async (resolve, reject) =&gt; {
            let path = `${uploadDir}/${HASH}`,
                fileList = [],
                suffix,
                isExists;
            isExists = await exists(path);
            if (!isExists) {
                reject('HASH path is not found!');
                return;
            }
            fileList = fs.readdirSync(path);
            if (fileList.length &lt; count) {
                reject('the slice has not been uploaded!');
                return;
            }
            fileList.sort((a, b) =&gt; {
                let reg = /_(\d+)/;
                return reg.exec(a)[1] - reg.exec(b)[1];
            }).forEach(item =&gt; {
                !suffix ? suffix = /\.([0-9a-zA-Z]+)$/.exec(item)[1] : null;
                fs.appendFileSync(`${uploadDir}/${HASH}.${suffix}`, fs.readFileSync(`${path}/${item}`));
                fs.unlinkSync(`${path}/${item}`);
            });
            fs.rmdirSync(path);
            resolve({
                path: `${uploadDir}/${HASH}.${suffix}`,
                filename: `${HASH}.${suffix}`
            });
        });
    };
    app.post('/upload_chunk', async (req, res) =&gt; {
        try {
            let {
                fields,
                files
            } = await multiparty_upload(req);
            let file = (files.file &amp;&amp; files.file[0]) || {},
                filename = (fields.filename &amp;&amp; fields.filename[0]) || &quot;&quot;,
                path = '',
                isExists = false;
            // 创建存放切片的临时目录
            let [, HASH] = /^([^_]+)_(\d+)/.exec(filename);
            path = `${uploadDir}/${HASH}`;
            !fs.existsSync(path) ? fs.mkdirSync(path) : null;
            // 把切片存储到临时目录中
            path = `${uploadDir}/${HASH}/${filename}`;
            isExists = await exists(path);
            if (isExists) {
                res.send({
                    code: 0,
                    codeText: 'file is exists',
                    originalFilename: filename,
                    servicePath: path.replace(__dirname, HOSTNAME)
                });
                return;
            }
            writeFile(res, path, file, filename, true);
        } catch (err) {
            res.send({
                code: 1,
                codeText: err
            });
        }
    });
    app.post('/upload_merge', async (req, res) =&gt; {
        let {
            HASH,
            count
        } = req.body;
        try {
            let {
                filename,
                path
            } = await merge(HASH, count);
            res.send({
                code: 0,
                codeText: 'merge success',
                originalFilename: filename,
                servicePath: path.replace(__dirname, HOSTNAME)
            });
        } catch (err) {
            res.send({
                code: 1,
                codeText: err
            });
        }
    });
    app.get('/upload_already', async (req, res) =&gt; {
        let {
            HASH
        } = req.query;
        let path = `${uploadDir}/${HASH}`,
            fileList = [];
        try {
            fileList = fs.readdirSync(path);
            fileList = fileList.sort((a, b) =&gt; {
                let reg = /_(\d+)/;
                return reg.exec(a)[1] - reg.exec(b)[1];
            });
            res.send({
                code: 0,
                codeText: '',
                fileList: fileList
            });
        } catch (err) {
            res.send({
                code: 0,
                codeText: '',
                fileList: fileList
            });
        }
    });
复制代码
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><strong>综上是我对文件上传的总结，能力有限，如有错误，望不吝指教，最后送上一句话：</strong></p> <blockquote><p>夫学须静也，才须学也，非学无以广才，非志无以成学。淫慢则不能励精，险躁则不能治性。年与时驰，意与日去，遂成枯落</p></blockquote> <p>关于本文</p> <h1 id="来源-麦忙"><a href="#来源-麦忙" class="header-anchor">#</a> 来源：麦忙</h1> <p>https://juejin.cn/post/7000654161297539079</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/27/2022, 9:04:59 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/3-高级api/图解JavaScript继承.html" class="prev">
        图解 JavaScript 继承，一文搞定继承相关知识
      </a></span> <span class="next"><a href="/advanced/3-高级api/手写简易版的axios.html">
        面试官不要再问我axios了？我能手写简易版的axios
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.6df8e219.js" defer></script><script src="/assets/js/2.e21ead49.js" defer></script><script src="/assets/js/25.69b254ca.js" defer></script>
  </body>
</html>
