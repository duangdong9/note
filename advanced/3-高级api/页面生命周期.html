<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>页面生命周期：DOMContentLoaded，load，beforeunload，unload | duangdong的note</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?0088ce24040b03f2947322ab31d23414";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
    <script>
  var _hmt = _hmt || [];
  _hmt.push(['_requirePlugin', 'UrlChangeTracker', {
    shouldTrackUrlChange: function (newPath, oldPath) {
      newPath = newPath.split('#')[0];
      oldPath = oldPath.split('#')[0];
      return newPath != oldPath;
    }}
  ]);
  </script>
    <meta name="description" content="前端相关知识归纳总结">
    <meta name="keywords" content="qd-blog,node,vuepress,leetcode,algorithm">
    
    <link rel="preload" href="/assets/css/0.styles.a427ee9b.css" as="style"><link rel="preload" href="/assets/js/app.6df8e219.js" as="script"><link rel="preload" href="/assets/js/2.e21ead49.js" as="script"><link rel="preload" href="/assets/js/27.9ae48125.js" as="script"><link rel="prefetch" href="/assets/js/10.e0bdad61.js"><link rel="prefetch" href="/assets/js/100.82a4c820.js"><link rel="prefetch" href="/assets/js/101.f5d94e3b.js"><link rel="prefetch" href="/assets/js/102.7f36fa51.js"><link rel="prefetch" href="/assets/js/103.085df24a.js"><link rel="prefetch" href="/assets/js/104.76789169.js"><link rel="prefetch" href="/assets/js/105.9efb3db9.js"><link rel="prefetch" href="/assets/js/106.22337f5b.js"><link rel="prefetch" href="/assets/js/107.ac8e17b4.js"><link rel="prefetch" href="/assets/js/108.5fe47bcc.js"><link rel="prefetch" href="/assets/js/109.cf88a409.js"><link rel="prefetch" href="/assets/js/11.e801cea9.js"><link rel="prefetch" href="/assets/js/110.603c3bd4.js"><link rel="prefetch" href="/assets/js/111.26f89c7d.js"><link rel="prefetch" href="/assets/js/112.1ad5bc54.js"><link rel="prefetch" href="/assets/js/113.cde31a40.js"><link rel="prefetch" href="/assets/js/114.a1a2a895.js"><link rel="prefetch" href="/assets/js/115.31c25d8b.js"><link rel="prefetch" href="/assets/js/116.8ed4b493.js"><link rel="prefetch" href="/assets/js/117.c802c1ce.js"><link rel="prefetch" href="/assets/js/118.15aead28.js"><link rel="prefetch" href="/assets/js/119.c26b6aad.js"><link rel="prefetch" href="/assets/js/12.9ed8f981.js"><link rel="prefetch" href="/assets/js/120.c3410f53.js"><link rel="prefetch" href="/assets/js/121.357fc3f4.js"><link rel="prefetch" href="/assets/js/122.6ecee0a8.js"><link rel="prefetch" href="/assets/js/123.6b38e86a.js"><link rel="prefetch" href="/assets/js/124.463231bb.js"><link rel="prefetch" href="/assets/js/125.dc9f9675.js"><link rel="prefetch" href="/assets/js/126.97f340de.js"><link rel="prefetch" href="/assets/js/127.080209f1.js"><link rel="prefetch" href="/assets/js/128.dd7fed27.js"><link rel="prefetch" href="/assets/js/129.e9a49c7b.js"><link rel="prefetch" href="/assets/js/13.fb60e043.js"><link rel="prefetch" href="/assets/js/130.86b31ea7.js"><link rel="prefetch" href="/assets/js/131.be4dca8f.js"><link rel="prefetch" href="/assets/js/132.a4e032bd.js"><link rel="prefetch" href="/assets/js/133.545d53fa.js"><link rel="prefetch" href="/assets/js/134.ef4512f0.js"><link rel="prefetch" href="/assets/js/135.b15ec030.js"><link rel="prefetch" href="/assets/js/136.14e63782.js"><link rel="prefetch" href="/assets/js/137.671e87f8.js"><link rel="prefetch" href="/assets/js/138.b3d28a52.js"><link rel="prefetch" href="/assets/js/139.bc5e381c.js"><link rel="prefetch" href="/assets/js/14.63057fe7.js"><link rel="prefetch" href="/assets/js/140.ce3a69fc.js"><link rel="prefetch" href="/assets/js/141.09737b5b.js"><link rel="prefetch" href="/assets/js/142.49e3bb24.js"><link rel="prefetch" href="/assets/js/143.45031fa6.js"><link rel="prefetch" href="/assets/js/144.458e287e.js"><link rel="prefetch" href="/assets/js/145.9d21ff24.js"><link rel="prefetch" href="/assets/js/146.88d47473.js"><link rel="prefetch" href="/assets/js/147.277b5759.js"><link rel="prefetch" href="/assets/js/148.0dd5c138.js"><link rel="prefetch" href="/assets/js/149.d638ab21.js"><link rel="prefetch" href="/assets/js/15.3ac2cfb4.js"><link rel="prefetch" href="/assets/js/150.834eb5ca.js"><link rel="prefetch" href="/assets/js/151.0b833f48.js"><link rel="prefetch" href="/assets/js/152.d212207c.js"><link rel="prefetch" href="/assets/js/153.e8b1311a.js"><link rel="prefetch" href="/assets/js/154.74eb8531.js"><link rel="prefetch" href="/assets/js/16.f2129a31.js"><link rel="prefetch" href="/assets/js/17.27a38c73.js"><link rel="prefetch" href="/assets/js/18.ec5b4213.js"><link rel="prefetch" href="/assets/js/19.553ed8c2.js"><link rel="prefetch" href="/assets/js/20.c1bf3bbb.js"><link rel="prefetch" href="/assets/js/21.5790bc21.js"><link rel="prefetch" href="/assets/js/22.29894e1b.js"><link rel="prefetch" href="/assets/js/23.bae1a497.js"><link rel="prefetch" href="/assets/js/24.1edc62bc.js"><link rel="prefetch" href="/assets/js/25.69b254ca.js"><link rel="prefetch" href="/assets/js/26.df57f236.js"><link rel="prefetch" href="/assets/js/28.d42d4bb6.js"><link rel="prefetch" href="/assets/js/29.f3630e2f.js"><link rel="prefetch" href="/assets/js/3.5c47a171.js"><link rel="prefetch" href="/assets/js/30.40cf5507.js"><link rel="prefetch" href="/assets/js/31.99b2787c.js"><link rel="prefetch" href="/assets/js/32.eef578d9.js"><link rel="prefetch" href="/assets/js/33.6755a6d2.js"><link rel="prefetch" href="/assets/js/34.add65d5c.js"><link rel="prefetch" href="/assets/js/35.3e4a0da9.js"><link rel="prefetch" href="/assets/js/36.9d4bd3f9.js"><link rel="prefetch" href="/assets/js/37.98506fd6.js"><link rel="prefetch" href="/assets/js/38.44bce283.js"><link rel="prefetch" href="/assets/js/39.62bf281f.js"><link rel="prefetch" href="/assets/js/4.8f6f0475.js"><link rel="prefetch" href="/assets/js/40.3a389edd.js"><link rel="prefetch" href="/assets/js/41.a309beb7.js"><link rel="prefetch" href="/assets/js/42.4e87216c.js"><link rel="prefetch" href="/assets/js/43.c6f6922b.js"><link rel="prefetch" href="/assets/js/44.fda8b3de.js"><link rel="prefetch" href="/assets/js/45.5a1c5b3b.js"><link rel="prefetch" href="/assets/js/46.289cbb81.js"><link rel="prefetch" href="/assets/js/47.81850ce8.js"><link rel="prefetch" href="/assets/js/48.e986629d.js"><link rel="prefetch" href="/assets/js/49.d04a41c3.js"><link rel="prefetch" href="/assets/js/5.8b87f02a.js"><link rel="prefetch" href="/assets/js/50.727fb121.js"><link rel="prefetch" href="/assets/js/51.a10ac8b0.js"><link rel="prefetch" href="/assets/js/52.4fffa0ef.js"><link rel="prefetch" href="/assets/js/53.03ab34e0.js"><link rel="prefetch" href="/assets/js/54.f05ee208.js"><link rel="prefetch" href="/assets/js/55.f90df177.js"><link rel="prefetch" href="/assets/js/56.86a4d03e.js"><link rel="prefetch" href="/assets/js/57.c8cee71c.js"><link rel="prefetch" href="/assets/js/58.0b503f53.js"><link rel="prefetch" href="/assets/js/59.c4daebc4.js"><link rel="prefetch" href="/assets/js/6.2f86309f.js"><link rel="prefetch" href="/assets/js/60.b9584ba1.js"><link rel="prefetch" href="/assets/js/61.fa6e5de3.js"><link rel="prefetch" href="/assets/js/62.4f67908f.js"><link rel="prefetch" href="/assets/js/63.0c9d8ccc.js"><link rel="prefetch" href="/assets/js/64.2754e515.js"><link rel="prefetch" href="/assets/js/65.f2bd6dd5.js"><link rel="prefetch" href="/assets/js/66.299c952c.js"><link rel="prefetch" href="/assets/js/67.2ccaf3ef.js"><link rel="prefetch" href="/assets/js/68.b6e197f0.js"><link rel="prefetch" href="/assets/js/69.b821ea5d.js"><link rel="prefetch" href="/assets/js/7.f1cc41de.js"><link rel="prefetch" href="/assets/js/70.7beae76c.js"><link rel="prefetch" href="/assets/js/71.d452a791.js"><link rel="prefetch" href="/assets/js/72.f3fd5168.js"><link rel="prefetch" href="/assets/js/73.0804c5f0.js"><link rel="prefetch" href="/assets/js/74.cdcdfbcc.js"><link rel="prefetch" href="/assets/js/75.e8e01c97.js"><link rel="prefetch" href="/assets/js/76.6801837d.js"><link rel="prefetch" href="/assets/js/77.04408d97.js"><link rel="prefetch" href="/assets/js/78.9130c8b3.js"><link rel="prefetch" href="/assets/js/79.dcf60589.js"><link rel="prefetch" href="/assets/js/8.89fa1943.js"><link rel="prefetch" href="/assets/js/80.efe0c1a1.js"><link rel="prefetch" href="/assets/js/81.8220fef3.js"><link rel="prefetch" href="/assets/js/82.ae2099d2.js"><link rel="prefetch" href="/assets/js/83.c563f161.js"><link rel="prefetch" href="/assets/js/84.e365194b.js"><link rel="prefetch" href="/assets/js/85.15de0cdb.js"><link rel="prefetch" href="/assets/js/86.b99959c5.js"><link rel="prefetch" href="/assets/js/87.6fccf3fc.js"><link rel="prefetch" href="/assets/js/88.9bc0613a.js"><link rel="prefetch" href="/assets/js/89.89530022.js"><link rel="prefetch" href="/assets/js/9.7637f327.js"><link rel="prefetch" href="/assets/js/90.53d12303.js"><link rel="prefetch" href="/assets/js/91.c55896d7.js"><link rel="prefetch" href="/assets/js/92.0fe1f724.js"><link rel="prefetch" href="/assets/js/93.d681c01d.js"><link rel="prefetch" href="/assets/js/94.ed89d267.js"><link rel="prefetch" href="/assets/js/95.96e675de.js"><link rel="prefetch" href="/assets/js/96.5ad7361e.js"><link rel="prefetch" href="/assets/js/97.e7f32727.js"><link rel="prefetch" href="/assets/js/98.c3a03e67.js"><link rel="prefetch" href="/assets/js/99.31f54446.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a427ee9b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">duangdong的note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/principle/" class="nav-link">
  JS执行
</a></div><div class="nav-item"><a href="/design-mode/" class="nav-link">
  JS设计模式
</a></div><div class="nav-item"><a href="/advanced/" class="nav-link router-link-active">
  JS进阶
</a></div><div class="nav-item"><a href="/advanced-function/" class="nav-link">
  高阶函数
</a></div><div class="nav-item"><a href="/typescript/" class="nav-link">
  TS
</a></div><div class="nav-item"><a href="/eight-essay/" class="nav-link">
  八股文
</a></div><div class="nav-item"><a href="/hand-writing/" class="nav-link">
  手写实现
</a></div><div class="nav-item"><a href="/mdn/" class="nav-link">
  MDN
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  工具方法
</a></div><div class="nav-item"><a href="https://link.qdzhou.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/advanced/" aria-current="page" class="sidebar-link">js 进阶</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>2-动画</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>3-高级api</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/advanced/3-高级api/JSB 原理与实践.html" class="sidebar-link">JSB 原理与实践</a></li><li><a href="/advanced/3-高级api/axios是如何封装HTTP请求的.html" class="sidebar-link">axios 是如何封装 HTTP 请求的</a></li><li><a href="/advanced/3-高级api/mutation-observer.html" class="sidebar-link">DOM 变动观察器（Mutation observer）</a></li><li><a href="/advanced/3-高级api/《You-Dont-Know-JS》笔记小计.html" class="sidebar-link">《You-Dont-Know-JS》笔记小计</a></li><li><a href="/advanced/3-高级api/前端鉴权.html" class="sidebar-link">前端鉴权必须了解的5个兄弟：cookie、session、token、jwt、单点登录</a></li><li><a href="/advanced/3-高级api/发布订阅模式.html" class="sidebar-link">JavaScript的发布订阅模式</a></li><li><a href="/advanced/3-高级api/图解JavaScript继承.html" class="sidebar-link">图解 JavaScript 继承，一文搞定继承相关知识</a></li><li><a href="/advanced/3-高级api/基于js管理大文件上传以及断点续传.html" class="sidebar-link">基于js管理大文件上传以及断点续传</a></li><li><a href="/advanced/3-高级api/手写简易版的axios.html" class="sidebar-link">面试官不要再问我axios了？我能手写简易版的axios</a></li><li><a href="/advanced/3-高级api/页面生命周期.html" class="active sidebar-link">页面生命周期：DOMContentLoaded，load，beforeunload，unload</a></li></ul></section></li><li><a href="/advanced/CORS完全手册之CORS详解.html" class="sidebar-link">CORS 完全手册之 CORS 详解</a></li><li><a href="/advanced/ES12新特性.html" class="sidebar-link">JavaScriptES12新特性抢先体验</a></li><li><a href="/advanced/前端模块化.html" class="sidebar-link">彻底掌握前端模块化</a></li><li><a href="/advanced/变量和类型-1.html" class="sidebar-link">变量和类型</a></li><li><a href="/advanced/变量和类型-2.html" class="sidebar-link">变量和类型-2</a></li><li><a href="/advanced/深入分析 JavaScript 模块循环引用.html" class="sidebar-link">深入分析 JavaScript 模块循环引用</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="页面生命周期-domcontentloaded-load-beforeunload-unload"><a href="#页面生命周期-domcontentloaded-load-beforeunload-unload" class="header-anchor">#</a> 页面生命周期：DOMContentLoaded，load，beforeunload，unload</h2> <blockquote><p><a href="https://mp.weixin.qq.com/s/TdHGLka-xlr8ER4BD2cjxQ" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/TdHGLka-xlr8ER4BD2cjxQ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>HTML 页面的生命周期包含三个重要事件：</p> <ul><li><code>DOMContentLoaded</code> —— 浏览器已完全加载 HTML，并构建了 DOM 树，但像 <code>&lt;img&gt;</code> 和样式表之类的外部资源可能尚未加载完成。</li> <li><code>load</code> —— 浏览器不仅加载完成了 HTML，还加载完成了所有外部资源：图片，样式等。</li> <li><code>beforeunload/unload</code> —— 当用户正在离开页面时。</li></ul> <p>每个事件都是有用的：</p> <ul><li><code>DOMContentLoaded</code> 事件 —— DOM 已经就绪，因此处理程序可以查找 DOM 节点，并初始化接口。</li> <li><code>load</code> 事件 —— 外部资源已加载完成，样式已被应用，图片大小也已知了。</li> <li><code>beforeunload</code> 事件 —— 用户正在离开：我们可以检查用户是否保存了更改，并询问他是否真的要离开。</li> <li><code>unload</code> 事件 —— 用户几乎已经离开了，但是我们仍然可以启动一些操作，例如发送统计数据。</li></ul> <p>我们探索一下这些事件的细节。</p> <h2 id="domcontentloaded"><a href="#domcontentloaded" class="header-anchor">#</a> DOMContentLoaded</h2> <p><code>DOMContentLoaded</code> 事件发生在 <code>document</code> 对象上。</p> <p>我们必须使用 <code>addEventListener</code> 来捕获它：</p> <div class="language- extra-class"><pre class="language-text"><code>document.addEventListener(&quot;DOMContentLoaded&quot;, ready);
// 不是 &quot;document.onDOMContentLoaded = ...&quot;
</code></pre></div><p>例如：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;script&gt;
  function ready() {
    alert('DOM is ready');

    // 图片目前尚未加载完成（除非已经被缓存），所以图片的大小为 0x0
    alert(`Image size: ${img.offsetWidth}x${img.offsetHeight}`);
  }

  document.addEventListener(&quot;DOMContentLoaded&quot;, ready);
&lt;/script&gt;

&lt;img id=&quot;img&quot; src=&quot;https://en.js.cx/clipart/train.gif?speed=1&amp;cache=0&quot;&gt;
</code></pre></div><p>在示例中，<code>DOMContentLoaded</code> 处理程序在文档加载完成后触发，所以它可以查看所有元素，包括它下面的 <code>&lt;img&gt;</code> 元素。</p> <p>但是，它不会等待图片加载。因此，<code>alert</code> 显示其大小为零。</p> <p>乍一看，<code>DOMContentLoaded</code> 事件非常简单。DOM 树准备就绪 —— 这是它的触发条件。它并没有什么特别之处。</p> <h3 id="domcontentloaded-和脚本"><a href="#domcontentloaded-和脚本" class="header-anchor">#</a> DOMContentLoaded 和脚本</h3> <p>当浏览器处理一个 HTML 文档，并在文档中遇到 <code>&lt;script&gt;</code> 标签时，就会在继续构建 DOM 之前运行它。这是一种防范措施，因为脚本可能想要修改 DOM，甚至对其执行 <code>document.write</code>操作，所以 <code>DOMContentLoaded</code> 必须等待脚本执行结束。</p> <p>因此，<code>DOMContentLoaded</code> 肯定在下面的这些脚本执行结束之后发生：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;script&gt;
  document.addEventListener(&quot;DOMContentLoaded&quot;, () =&gt; {
    alert(&quot;DOM ready!&quot;);
  });
&lt;/script&gt;

&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js&quot;&gt;&lt;/script&gt;

&lt;script&gt;
  alert(&quot;Library loaded, inline script executed&quot;);
&lt;/script&gt;
</code></pre></div><p>在上面这个例子中，我们首先会看到 &quot;Library loaded...&quot;，然后才会看到 &quot;DOM ready!&quot;（所有脚本都已经执行结束）。</p> <blockquote><p><strong>不会阻塞 <code>DOMContentLoaded</code> 的脚本：</strong></p> <p>此规则有两个例外：</p> <ol><li>具有 <code>async</code> 特性（attribute）的脚本不会阻塞 <code>DOMContentLoaded</code>，<strong>稍后</strong>[1] 我们会讲到。</li> <li>使用 <code>document.createElement('script')</code> 动态生成并添加到网页的脚本也不会阻塞 <code>DOMContentLoaded</code>。</li></ol></blockquote> <h3 id="domcontentloaded-和样式"><a href="#domcontentloaded-和样式" class="header-anchor">#</a> DOMContentLoaded 和样式</h3> <p>外部样式表不会影响 DOM，因此 <code>DOMContentLoaded</code> 不会等待它们。</p> <p>但这里有一个陷阱。如果在样式后面有一个脚本，那么该脚本必须等待样式表加载完成：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;style.css&quot;&gt;
&lt;script&gt;
  // 在样式表加载完成之前，脚本都不会执行
  alert(getComputedStyle(document.body).marginTop);
&lt;/script&gt;
</code></pre></div><p>原因是，脚本可能想要获取元素的坐标和其他与样式相关的属性，如上例所示。因此，它必须等待样式加载完成。</p> <p>当 <code>DOMContentLoaded</code> 等待脚本时，它现在也在等待脚本前面的样式。</p> <h3 id="浏览器内建的自动填充"><a href="#浏览器内建的自动填充" class="header-anchor">#</a> 浏览器内建的自动填充</h3> <p>Firefox，Chrome 和 Opera 都会在 <code>DOMContentLoaded</code> 中自动填充表单。</p> <p>例如，如果页面有一个带有登录名和密码的表单，并且浏览器记住了这些值，那么在 <code>DOMContentLoaded</code> 上，浏览器会尝试自动填充它们（如果得到了用户允许）。</p> <p>因此，如果 <code>DOMContentLoaded</code> 被需要加载很长时间的脚本延迟触发，那么自动填充也会等待。你可能在某些网站上看到过（如果你使用浏览器自动填充）—— 登录名/密码字段不会立即自动填充，而是在页面被完全加载前会延迟填充。这实际上是 <code>DOMContentLoaded</code> 事件之前的延迟。</p> <h2 id="window-onload"><a href="#window-onload" class="header-anchor">#</a> window.onload</h2> <p>当整个页面，包括样式、图片和其他资源被加载完成时，会触发 <code>window</code> 对象上的 <code>load</code> 事件。可以通过 <code>onload</code> 属性获取此事件。</p> <p>下面的这个示例正确显示了图片大小，因为 <code>window.onload</code> 会等待所有图片加载完毕：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;script&gt;
  window.onload = function() { // 与此相同 window.addEventListener('load', (event) =&gt; {
    alert('Page loaded');

    // 此时图片已经加载完成
    alert(`Image size: ${img.offsetWidth}x${img.offsetHeight}`);
  };
&lt;/script&gt;

&lt;img id=&quot;img&quot; src=&quot;https://en.js.cx/clipart/train.gif?speed=1&amp;cache=0&quot;&gt;
</code></pre></div><h2 id="window-onunload"><a href="#window-onunload" class="header-anchor">#</a> window.onunload</h2> <p>当访问者离开页面时，<code>window</code> 对象上的 <code>unload</code> 事件就会被触发。我们可以在那里做一些不涉及延迟的操作，例如关闭相关的弹出窗口。</p> <p>有一个值得注意的特殊情况是发送分析数据。</p> <p>假设我们收集有关页面使用情况的数据：鼠标点击，滚动，被查看的页面区域等。</p> <p>自然地，当用户要离开的时候，我们希望通过 <code>unload</code> 事件将数据保存到我们的服务器上。</p> <p>有一个特殊的 <code>navigator.sendBeacon(url, data)</code> 方法可以满足这种需求，详见规范 https://w3c.github.io/beacon/。</p> <p>它在后台发送数据，转换到另外一个页面不会有延迟：浏览器离开页面，但仍然在执行 <code>sendBeacon</code>。</p> <p>使用方式如下：</p> <div class="language- extra-class"><pre class="language-text"><code>let analyticsData = { /* 带有收集的数据的对象 */ };

window.addEventListener(&quot;unload&quot;, function() {
  navigator.sendBeacon(&quot;/analytics&quot;, JSON.stringify(analyticsData));
});
</code></pre></div><ul><li>请求以 POST 方式发送。</li> <li>我们不仅能发送字符串，还能发送表单以及其他格式的数据，在 Fetch 一章有详细讲解，但通常它是一个字符串化的对象。</li> <li>数据大小限制在 64kb。</li></ul> <p>当 <code>sendBeacon</code> 请求完成时，浏览器可能已经离开了文档，所以就无法获取服务器响应（对于分析数据来说通常为空）。</p> <p>还有一个 <code>keep-alive</code> 标志，该标志用于在 <strong>fetch</strong>[2] 方法中为通用的网络请求执行此类“离开页面后”的请求。你可以在 <strong>Fetch API</strong>[3] 一章中找到更多相关信息。</p> <p>如果我们要取消跳转到另一页面的操作，在这里做不到。但是我们可以使用另一个事件 —— <code>onbeforeunload</code>。</p> <h2 id="window-onbeforeunload"><a href="#window-onbeforeunload" class="header-anchor">#</a> window.onbeforeunload</h2> <p>如果访问者触发了离开页面的导航（navigation）或试图关闭窗口，<code>beforeunload</code> 处理程序将要求进行更多确认。</p> <p>如果我们要取消事件，浏览器会询问用户是否确定。</p> <p>你可以通过运行下面这段代码，然后重新加载页面来进行尝试：</p> <div class="language- extra-class"><pre class="language-text"><code>window.onbeforeunload = function() {
  return false;
};
</code></pre></div><p>由于历史原因，返回非空字符串也被视为取消事件。在以前，浏览器曾经将其显示为消息，但是根据 <strong>现代规范</strong>[4] 所述，它们不应该这样。</p> <p>这里有个例子：</p> <div class="language- extra-class"><pre class="language-text"><code>window.onbeforeunload = function() {
  return &quot;There are unsaved changes. Leave now?&quot;;
};
</code></pre></div><p>它的行为已经改变了，因为有些站长通过显示误导性和恶意信息滥用了此事件处理程序。所以，目前一些旧的浏览器可能仍将其显示为消息，但除此之外 —— 无法自定义显示给用户的消息。</p> <h2 id="readystate"><a href="#readystate" class="header-anchor">#</a> readyState</h2> <p>如果我们将 <code>DOMContentLoaded</code> 事件处理程序设置在文档加载完成之后，会发生什么？</p> <p>很自然地，它永远不会运行。</p> <p>在某些情况下，我们不确定文档是否已经准备就绪。我们希望我们的函数在 DOM 加载完成时执行，无论现在还是以后。</p> <p><code>document.readyState</code> 属性可以为我们提供当前加载状态的信息。</p> <p>它有 3 个可能值：</p> <ul><li><code>loading</code> —— 文档正在被加载。</li> <li><code>interactive</code> —— 文档被全部读取。</li> <li><code>complete</code> —— 文档被全部读取，并且所有资源（例如图片等）都已加载完成。</li></ul> <p>所以，我们可以检查 <code>document.readyState</code> 并设置一个处理程序，或在代码准备就绪时立即执行它。</p> <p>像这样：</p> <div class="language- extra-class"><pre class="language-text"><code>function work() { /*...*/ }

if (document.readyState == 'loading') {
  // 仍在加载，等待事件
  document.addEventListener('DOMContentLoaded', work);
} else {
  // DOM 已就绪！
  work();
}
</code></pre></div><p>还有一个 <code>readystatechange</code> 事件，会在状态发生改变时触发，因此我们可以打印所有这些状态，就像这样：</p> <div class="language- extra-class"><pre class="language-text"><code>// 当前状态
console.log(document.readyState);

// 状态改变时打印它
document.addEventListener('readystatechange', () =&gt; console.log(document.readyState));
</code></pre></div><p><code>readystatechange</code> 事件是跟踪文档加载状态的另一种机制，它很早就存在了。现在则很少被使用。</p> <p>但是为了完整起见，让我们看看完整的事件流。</p> <p>这是一个带有 <code>&lt;iframe&gt;</code>，<code>&lt;img&gt;</code> 和记录事件的处理程序的文档：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;script&gt;
  log('initial readyState:' + document.readyState);

  document.addEventListener('readystatechange', () =&gt; log('readyState:' + document.readyState));
  document.addEventListener('DOMContentLoaded', () =&gt; log('DOMContentLoaded'));

  window.onload = () =&gt; log('window onload');
&lt;/script&gt;

&lt;iframe src=&quot;iframe.html&quot; onload=&quot;log('iframe onload')&quot;&gt;&lt;/iframe&gt;

&lt;img src=&quot;http://en.js.cx/clipart/train.gif&quot; id=&quot;img&quot;&gt;
&lt;script&gt;
  img.onload = () =&gt; log('img onload');
&lt;/script&gt;
</code></pre></div><p>此示例运行 <strong>在 sandbox 中</strong>[5]。</p> <p>典型输出：</p> <ol><li>[1] initial readyState:loading</li> <li>[2] readyState:interactive</li> <li>[2] DOMContentLoaded</li> <li>[3] iframe onload</li> <li>[4] img onload</li> <li>[4] readyState:complete</li> <li>[4] window onload</li></ol> <p>方括号中的数字表示发生这种情况的大致时间。标有相同数字的事件几乎是同时发生的（+- 几毫秒）。</p> <ul><li>在 <code>DOMContentLoaded</code> 之前，<code>document.readyState</code> 会立即变成 <code>interactive</code>。它们俩的意义实际上是相同的。</li> <li>当所有资源（<code>iframe</code> 和 <code>img</code>）都加载完成后，<code>document.readyState</code> 变成 <code>complete</code>。这里我们可以发现，它与 <code>img.onload</code>（<code>img</code> 是最后一个资源）和 <code>window.onload</code> 几乎同时发生。转换到 <code>complete</code> 状态的意义与 <code>window.onload</code> 相同。区别在于 <code>window.onload</code> 始终在所有其他 <code>load</code> 处理程序之后运行。</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>页面生命周期事件：</p> <ul><li><p>当 DOM 准备就绪时，<code>document</code> 上的 <code>DOMContentLoaded</code> 事件就会被触发。在这个阶段，我们可以将 JavaScript 应用于元素。</p></li> <li><ul><li>诸如 <code>&lt;script&gt;...&lt;/script&gt;</code> 或 <code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code> 之类的脚本会阻塞  <code>DOMContentLoaded</code>，浏览器将等待它们执行结束。</li> <li>图片和其他资源仍然可以继续被加载。</li></ul></li> <li><p>当页面和所有资源都加载完成时，<code>window</code> 上的 <code>load</code> 事件就会被触发。我们很少使用它，因为通常无需等待那么长时间。</p></li> <li><p>当用户想要离开页面时，<code>window</code> 上的 <code>beforeunload</code> 事件就会被触发。如果我们取消这个事件，浏览器就会询问我们是否真的要离开（例如，我们有未保存的更改）。</p></li> <li><p>当用户最终离开时，<code>window</code> 上的 <code>unload</code> 事件就会被触发。在处理程序中，我们只能执行不涉及延迟或询问用户的简单操作。正是由于这个限制，它很少被使用。我们可以使用 <code>navigator.sendBeacon</code> 来发送网络请求。</p></li> <li><p><code>document.readyState</code> 是文档的当前状态，可以在 <code>readystatechange</code> 事件中跟踪状态更改：</p></li> <li><ul><li><code>loading</code> —— 文档正在被加载。</li> <li><code>interactive</code> —— 文档已被解析完成，与 <code>DOMContentLoaded</code> 几乎同时发生，但是在 <code>DOMContentLoaded</code> 之前发生。</li> <li><code>complete</code> —— 文档和资源均已加载完成，与 <code>window.onload</code> 几乎同时发生，但是在 <code>window.onload</code> 之前发生。</li></ul></li></ul> <hr> <blockquote><p>现代 JavaScript 教程：开源的现代 JavaScript 从入门到进阶的优质教程。<strong>React 官方文档推荐，与 MDN 并列的 JavaScript 学习教程</strong>[6]。</p> <p>在线免费阅读：https://zh.javascript.info</p></blockquote> <hr> <h3 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h3> <p>[1]稍后: <em>https://zh.javascript.info/script-async-defer</em>[2]fetch: <em>https://zh.javascript.info/fetch</em>[3]Fetch API: <em>https://zh.javascript.info/fetch-api</em>[4]现代规范: <em>https://html.spec.whatwg.org/#unloading-documents</em>[5]在 sandbox 中: <em>https://plnkr.co/edit/ct5SNvrHCA75b2KZ?p=preview</em>[6]React 官方文档推荐，与 MDN 并列的 JavaScript 学习教程: <em>https://zh-hans.reactjs.org/docs/getting-started.html#javascript-resources</em></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/27/2022, 9:04:59 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/advanced/3-高级api/手写简易版的axios.html" class="prev">
        面试官不要再问我axios了？我能手写简易版的axios
      </a></span> <span class="next"><a href="/advanced/CORS完全手册之CORS详解.html">
        CORS 完全手册之 CORS 详解
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.6df8e219.js" defer></script><script src="/assets/js/2.e21ead49.js" defer></script><script src="/assets/js/27.9ae48125.js" defer></script>
  </body>
</html>
